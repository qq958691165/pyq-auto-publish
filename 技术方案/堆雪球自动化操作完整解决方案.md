# å †é›ªçƒè‡ªåŠ¨åŒ–æ“ä½œå®Œæ•´è§£å†³æ–¹æ¡ˆ

## ğŸ“‹ é—®é¢˜åˆ†æ

### ğŸ” æ ¸å¿ƒé—®é¢˜
åˆ€ä»”è€æ¿æ‹…å¿ƒç³»ç»Ÿæ— æ³•æ¥å…¥å½±åˆ€RPAï¼Œéœ€è¦æ‰¾åˆ°å…¶ä»–æ–¹å¼è‡ªåŠ¨åŒ–æ“ä½œå †é›ªçƒç³»ç»Ÿã€‚

### ğŸ¯ å †é›ªçƒç³»ç»Ÿç‰¹ç‚¹
- **ç³»ç»Ÿç±»å‹**: Webç®¡ç†åå°
- **è®¿é—®åœ°å€**: https://dxqscrm.duixueqiu.cn/admin
- **éœ€è¦ç™»å½•**: è´¦å·å¯†ç ç™»å½•
- **æ ¸å¿ƒåŠŸèƒ½**: å¾®ä¿¡æœ‹å‹åœˆè‡ªåŠ¨å‘å¸ƒ

### âš ï¸ å½±åˆ€RPAçš„å±€é™æ€§
1. **æˆæœ¬é—®é¢˜** - ä¼ä¸šç‰ˆ500-2000å…ƒ/å¹´
2. **ä¾èµ–æ€§å¼º** - ä¾èµ–ç¬¬ä¸‰æ–¹æœåŠ¡ç¨³å®šæ€§
3. **é…ç½®å¤æ‚** - éœ€è¦åœ¨æ§åˆ¶å°é¢„å…ˆé…ç½®ä»»åŠ¡
4. **çµæ´»æ€§ä½** - åŠŸèƒ½å—é™äºå½±åˆ€æä¾›çš„èƒ½åŠ›

---

## ğŸ¯ ä¸‰ç§è‡ªåŠ¨åŒ–æ–¹æ¡ˆå¯¹æ¯”

| å¯¹æ¯”é¡¹ | Puppeteer/Playwright | å½±åˆ€RPAä¼ä¸šç‰ˆ | å †é›ªçƒå®˜æ–¹API |
|--------|---------------------|--------------|--------------|
| **æˆæœ¬** | âœ… å…è´¹ | âŒ 500-2000å…ƒ/å¹´ | â“ æœªçŸ¥ï¼ˆå¯èƒ½ä¸å­˜åœ¨ï¼‰ |
| **å¼€å‘éš¾åº¦** | â­â­â­ ä¸­ç­‰ | â­â­ ä½ | â­ æä½ |
| **ç»´æŠ¤æˆæœ¬** | â­â­â­ ä¸­ç­‰ | â­â­ ä½ | â­ æä½ |
| **çµæ´»æ€§** | âœ… æé«˜ | â­â­â­ ä¸­ç­‰ | âœ… é«˜ |
| **å¯æ§æ€§** | âœ… å®Œå…¨å¯æ§ | âŒ ä¾èµ–ç¬¬ä¸‰æ–¹ | âŒ ä¾èµ–å®˜æ–¹ |
| **ç¨³å®šæ€§** | âœ… é«˜ï¼ˆè‡ªå·±ç»´æŠ¤ï¼‰ | â­â­â­ ä¸­ç­‰ | âœ… é«˜ |
| **æŠ€æœ¯é—¨æ§›** | â­â­â­ éœ€è¦å‰ç«¯çŸ¥è¯† | â­ ä½ | â­ ä½ |
| **é›†æˆéš¾åº¦** | âœ… ç›´æ¥é›†æˆåˆ°åç«¯ | â­â­â­ éœ€è¦APIå¯¹æ¥ | âœ… ç›´æ¥è°ƒç”¨ |
| **æ¨èåº¦** | â­â­â­â­â­ | â­â­â­ | â­â­â­â­â­ï¼ˆå¦‚æœå­˜åœ¨ï¼‰ |

### ğŸ’¡ ç»“è®º
**æ¨èä½¿ç”¨ Puppeteer/Playwright æ–¹æ¡ˆ**ï¼ŒåŸå› ï¼š
1. âœ… å®Œå…¨å…è´¹ï¼Œæ— é¢å¤–æˆæœ¬
2. âœ… å®Œå…¨å¯æ§ï¼Œä¸ä¾èµ–ç¬¬ä¸‰æ–¹
3. âœ… å¯ä»¥ç›´æ¥é›†æˆåˆ°NestJSåç«¯
4. âœ… æŠ€æœ¯æˆç†Ÿï¼Œæ–‡æ¡£å®Œå–„
5. âœ… å¯ä»¥å¤„ç†ä»»ä½•Webé¡µé¢æ“ä½œ

---

## ğŸ”§ Puppeteeræ–¹æ¡ˆå®Œæ•´å®ç°

### ğŸ“¦ æŠ€æœ¯æ ˆ
```json
{
  "puppeteer": "^21.0.0",
  "puppeteer-extra": "^3.3.6",
  "puppeteer-extra-plugin-stealth": "^2.11.2"
}
```

### ğŸ¯ æ ¸å¿ƒåŠŸèƒ½æ¨¡å—

#### 1ï¸âƒ£ å †é›ªçƒè‡ªåŠ¨åŒ–æœåŠ¡ç±»

```typescript
// src/services/duixueqiu-automation.service.ts
import { Injectable, Logger } from '@nestjs/common';
import puppeteer from 'puppeteer-extra';
import StealthPlugin from 'puppeteer-extra-plugin-stealth';
import { Browser, Page } from 'puppeteer';

// ä½¿ç”¨éšèº«æ’ä»¶é¿å…è¢«æ£€æµ‹
puppeteer.use(StealthPlugin());

@Injectable()
export class DuixueqiuAutomationService {
  private readonly logger = new Logger(DuixueqiuAutomationService.name);
  private browser: Browser;
  private page: Page;

  /**
   * åˆå§‹åŒ–æµè§ˆå™¨
   */
  async initBrowser() {
    this.logger.log('æ­£åœ¨å¯åŠ¨æµè§ˆå™¨...');
    this.browser = await puppeteer.launch({
      headless: true, // ç”Ÿäº§ç¯å¢ƒä½¿ç”¨æ— å¤´æ¨¡å¼
      args: [
        '--no-sandbox',
        '--disable-setuid-sandbox',
        '--disable-dev-shm-usage',
        '--disable-accelerated-2d-canvas',
        '--disable-gpu',
        '--window-size=1920x1080'
      ]
    });
    this.page = await this.browser.newPage();
    
    // è®¾ç½®è§†å£å¤§å°
    await this.page.setViewport({ width: 1920, height: 1080 });
    
    // è®¾ç½®User-Agentæ¨¡æ‹ŸçœŸå®æµè§ˆå™¨
    await this.page.setUserAgent(
      'Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/120.0.0.0 Safari/537.36'
    );
    
    this.logger.log('æµè§ˆå™¨å¯åŠ¨æˆåŠŸ');
  }

  /**
   * ç™»å½•å †é›ªçƒç³»ç»Ÿ
   */
  async login(username: string, password: string): Promise<boolean> {
    try {
      this.logger.log('æ­£åœ¨ç™»å½•å †é›ªçƒç³»ç»Ÿ...');
      
      // è®¿é—®ç™»å½•é¡µé¢
      await this.page.goto('https://dxqscrm.duixueqiu.cn/admin/#/login', {
        waitUntil: 'networkidle2',
        timeout: 30000
      });

      // ç­‰å¾…ç™»å½•è¡¨å•åŠ è½½
      await this.page.waitForSelector('input[placeholder="è´¦å·"]', { timeout: 10000 });

      // è¾“å…¥è´¦å·
      await this.page.type('input[placeholder="è´¦å·"]', username, { delay: 100 });
      
      // è¾“å…¥å¯†ç 
      await this.page.type('input[placeholder="å¯†ç "]', password, { delay: 100 });

      // ç‚¹å‡»ç™»å½•æŒ‰é’®
      await this.page.click('button:has-text("ç™»å½•")');

      // ç­‰å¾…ç™»å½•æˆåŠŸï¼ˆç­‰å¾…é¡µé¢è·³è½¬ï¼‰
      await this.page.waitForNavigation({ waitUntil: 'networkidle2', timeout: 10000 });

      this.logger.log('ç™»å½•æˆåŠŸ');
      return true;
    } catch (error) {
      this.logger.error('ç™»å½•å¤±è´¥', error);
      return false;
    }
  }

  /**
   * å‘å¸ƒæœ‹å‹åœˆ
   */
  async publishMoment(params: {
    content: string;           // æ–‡æ¡ˆå†…å®¹
    images: string[];          // å›¾ç‰‡æœ¬åœ°è·¯å¾„æ•°ç»„
    wechatAccounts: string[];  // å¾®ä¿¡è´¦å·åˆ—è¡¨
    publishTime?: Date;        // å‘å¸ƒæ—¶é—´ï¼ˆå¯é€‰ï¼Œç«‹å³å‘å¸ƒåˆ™ä¸ä¼ ï¼‰
  }): Promise<boolean> {
    try {
      this.logger.log('å¼€å§‹å‘å¸ƒæœ‹å‹åœˆ...');

      // 1. å¯¼èˆªåˆ°æœ‹å‹åœˆå‘å¸ƒé¡µé¢
      await this.page.goto('https://dxqscrm.duixueqiu.cn/admin/#/wechat/moments/publish', {
        waitUntil: 'networkidle2',
        timeout: 30000
      });

      // 2. å¡«å†™æ–‡æ¡ˆå†…å®¹
      await this.page.waitForSelector('textarea.content-input', { timeout: 10000 });
      await this.page.type('textarea.content-input', params.content, { delay: 50 });

      // 3. ä¸Šä¼ å›¾ç‰‡
      if (params.images && params.images.length > 0) {
        const fileInput = await this.page.$('input[type="file"]');
        if (fileInput) {
          await fileInput.uploadFile(...params.images);
          
          // ç­‰å¾…å›¾ç‰‡ä¸Šä¼ å®Œæˆ
          await this.page.waitForTimeout(2000);
        }
      }

      // 4. é€‰æ‹©å¾®ä¿¡è´¦å·
      for (const account of params.wechatAccounts) {
        await this.page.click(`input[value="${account}"]`);
      }

      // 5. è®¾ç½®å‘å¸ƒæ—¶é—´
      if (params.publishTime) {
        // ç‚¹å‡»å®šæ—¶å‘å¸ƒ
        await this.page.click('input[type="radio"][value="scheduled"]');
        
        // è®¾ç½®æ—¶é—´ï¼ˆå…·ä½“é€‰æ‹©å™¨éœ€è¦æ ¹æ®å®é™…é¡µé¢è°ƒæ•´ï¼‰
        const timeString = params.publishTime.toLocaleString('zh-CN');
        await this.page.type('input.time-picker', timeString);
      } else {
        // ç«‹å³å‘å¸ƒ
        await this.page.click('input[type="radio"][value="immediate"]');
      }

      // 6. ç‚¹å‡»å‘å¸ƒæŒ‰é’®
      await this.page.click('button.publish-btn');

      // 7. ç­‰å¾…å‘å¸ƒæˆåŠŸæç¤º
      await this.page.waitForSelector('.success-message', { timeout: 10000 });

      this.logger.log('æœ‹å‹åœˆå‘å¸ƒæˆåŠŸ');
      return true;
    } catch (error) {
      this.logger.error('å‘å¸ƒæœ‹å‹åœˆå¤±è´¥', error);
      
      // æˆªå›¾ä¿å­˜é”™è¯¯ç°åœº
      await this.page.screenshot({ 
        path: `./error-screenshots/publish-error-${Date.now()}.png` 
      });
      
      return false;
    }
  }

  /**
   * å…³é—­æµè§ˆå™¨
   */
  async closeBrowser() {
    if (this.browser) {
      await this.browser.close();
      this.logger.log('æµè§ˆå™¨å·²å…³é—­');
    }
  }

  /**
   * è·å–é¡µé¢æˆªå›¾ï¼ˆç”¨äºè°ƒè¯•ï¼‰
   */
  async takeScreenshot(filename: string) {
    await this.page.screenshot({ path: filename });
  }
}
```

#### 2ï¸âƒ£ å‘å¸ƒä»»åŠ¡å¤„ç†å™¨

```typescript
// src/processors/publish-task.processor.ts
import { Processor, Process } from '@nestjs/bull';
import { Job } from 'bull';
import { DuixueqiuAutomationService } from '../services/duixueqiu-automation.service';
import { PrismaService } from '../services/prisma.service';

@Processor('publish-queue')
export class PublishTaskProcessor {
  constructor(
    private duixueqiuService: DuixueqiuAutomationService,
    private prisma: PrismaService
  ) {}

  @Process('publish-moment')
  async handlePublishTask(job: Job) {
    const { taskId, content, images, wechatAccounts, publishTime } = job.data;

    try {
      // 1. æ›´æ–°ä»»åŠ¡çŠ¶æ€ä¸º"å¤„ç†ä¸­"
      await this.prisma.publishTask.update({
        where: { id: taskId },
        data: { status: 'processing' }
      });

      // 2. åˆå§‹åŒ–æµè§ˆå™¨
      await this.duixueqiuService.initBrowser();

      // 3. ç™»å½•å †é›ªçƒ
      const loginSuccess = await this.duixueqiuService.login(
        process.env.DUIXUEQIU_USERNAME,
        process.env.DUIXUEQIU_PASSWORD
      );

      if (!loginSuccess) {
        throw new Error('ç™»å½•å †é›ªçƒå¤±è´¥');
      }

      // 4. å‘å¸ƒæœ‹å‹åœˆ
      const publishSuccess = await this.duixueqiuService.publishMoment({
        content,
        images,
        wechatAccounts,
        publishTime: publishTime ? new Date(publishTime) : undefined
      });

      if (!publishSuccess) {
        throw new Error('å‘å¸ƒæœ‹å‹åœˆå¤±è´¥');
      }

      // 5. æ›´æ–°ä»»åŠ¡çŠ¶æ€ä¸º"æˆåŠŸ"
      await this.prisma.publishTask.update({
        where: { id: taskId },
        data: { 
          status: 'success',
          publishedAt: new Date()
        }
      });

      // 6. å…³é—­æµè§ˆå™¨
      await this.duixueqiuService.closeBrowser();

      return { success: true, taskId };
    } catch (error) {
      // æ›´æ–°ä»»åŠ¡çŠ¶æ€ä¸º"å¤±è´¥"
      await this.prisma.publishTask.update({
        where: { id: taskId },
        data: { 
          status: 'failed',
          errorMessage: error.message
        }
      });

      // å…³é—­æµè§ˆå™¨
      await this.duixueqiuService.closeBrowser();

      throw error;
    }
  }
}
```

---

## ğŸ”„ å®Œæ•´ä¸šåŠ¡æµç¨‹

```
ç”¨æˆ·åœ¨Webç³»ç»Ÿè¾“å…¥å…¬ä¼—å·é“¾æ¥
  â†“
Cozeå·¥ä½œæµé‡‡é›†æ–‡æ¡ˆå’Œå›¾ç‰‡
  â†“
åç«¯ä¸‹è½½å›¾ç‰‡åˆ°æœåŠ¡å™¨æœ¬åœ°
  â†“
åˆ›å»ºå‘å¸ƒä»»åŠ¡ï¼ŒåŠ å…¥Bullé˜Ÿåˆ—
  â†“
PublishTaskProcessorå¤„ç†ä»»åŠ¡ï¼š
  1. å¯åŠ¨Puppeteeræµè§ˆå™¨
  2. ç™»å½•å †é›ªçƒç³»ç»Ÿ
  3. å¯¼èˆªåˆ°å‘å¸ƒé¡µé¢
  4. å¡«å†™æ–‡æ¡ˆ
  5. ä¸Šä¼ å›¾ç‰‡
  6. é€‰æ‹©å¾®ä¿¡è´¦å·
  7. è®¾ç½®å‘å¸ƒæ—¶é—´
  8. ç‚¹å‡»å‘å¸ƒ
  9. ç­‰å¾…æˆåŠŸæç¤º
  10. å…³é—­æµè§ˆå™¨
  â†“
æ›´æ–°æ•°æ®åº“ä»»åŠ¡çŠ¶æ€
  â†“
å‰ç«¯æ˜¾ç¤ºå‘å¸ƒç»“æœ
```

---

## ğŸ›¡ï¸ é˜²å°ç­–ç•¥

### 1ï¸âƒ£ æ¨¡æ‹ŸçœŸå®ç”¨æˆ·è¡Œä¸º
```typescript
// éšæœºå»¶è¿Ÿ
const randomDelay = () => Math.floor(Math.random() * 1000) + 500;
await this.page.waitForTimeout(randomDelay());

// æ¨¡æ‹Ÿé¼ æ ‡ç§»åŠ¨
await this.page.mouse.move(100, 100);
await this.page.mouse.move(200, 200);
```

### 2ï¸âƒ£ ä½¿ç”¨Stealthæ’ä»¶
```typescript
import StealthPlugin from 'puppeteer-extra-plugin-stealth';
puppeteer.use(StealthPlugin());
```

### 3ï¸âƒ£ è®¾ç½®çœŸå®User-Agent
```typescript
await this.page.setUserAgent(
  'Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36'
);
```

### 4ï¸âƒ£ æ§åˆ¶å‘å¸ƒé¢‘ç‡
```typescript
// æ¯ä¸ªè´¦å·æ¯å¤©æœ€å¤šå‘å¸ƒ10æ¡
// å‘å¸ƒé—´éš”è‡³å°‘30åˆ†é’Ÿ
```

---

## ğŸš€ éƒ¨ç½²å»ºè®®

### 1ï¸âƒ£ æœåŠ¡å™¨è¦æ±‚
- **å†…å­˜**: è‡³å°‘2GBï¼ˆè¿è¡Œæµè§ˆå™¨ï¼‰
- **CPU**: 2æ ¸ä»¥ä¸Š
- **ç³»ç»Ÿ**: Ubuntu 20.04+ / CentOS 7+

### 2ï¸âƒ£ å®‰è£…ä¾èµ–
```bash
# å®‰è£…Chromeä¾èµ–
sudo apt-get install -y \
  chromium-browser \
  fonts-liberation \
  libasound2 \
  libatk-bridge2.0-0 \
  libatk1.0-0 \
  libcups2 \
  libdbus-1-3 \
  libgdk-pixbuf2.0-0 \
  libnspr4 \
  libnss3 \
  libx11-xcb1 \
  libxcomposite1 \
  libxdamage1 \
  libxrandr2 \
  xdg-utils
```

### 3ï¸âƒ£ ç¯å¢ƒå˜é‡é…ç½®
```env
# .env
DUIXUEQIU_USERNAME=your_username
DUIXUEQIU_PASSWORD=your_password
PUPPETEER_EXECUTABLE_PATH=/usr/bin/chromium-browser
```

---

## âœ… æ–¹æ¡ˆä¼˜åŠ¿æ€»ç»“

| ä¼˜åŠ¿ | è¯´æ˜ |
|------|------|
| ğŸ’° **é›¶æˆæœ¬** | å®Œå…¨å…è´¹ï¼Œæ— éœ€è´­ä¹°å½±åˆ€ä¼ä¸šç‰ˆ |
| ğŸ¯ **å®Œå…¨å¯æ§** | ä»£ç å®Œå…¨æŒæ¡åœ¨è‡ªå·±æ‰‹ä¸­ |
| ğŸ”§ **é«˜åº¦çµæ´»** | å¯ä»¥å¤„ç†ä»»ä½•Webé¡µé¢æ“ä½œ |
| ğŸ“¦ **æ˜“äºé›†æˆ** | ç›´æ¥é›†æˆåˆ°NestJSåç«¯ |
| ğŸ›¡ï¸ **å®‰å…¨å¯é ** | ä¸ä¾èµ–ç¬¬ä¸‰æ–¹æœåŠ¡ |
| ğŸ“Š **æ˜“äºç›‘æ§** | å¯ä»¥è®°å½•è¯¦ç»†æ—¥å¿—å’Œæˆªå›¾ |
| ğŸ”„ **æ˜“äºç»´æŠ¤** | ä»£ç é€»è¾‘æ¸…æ™°ï¼Œä¾¿äºè°ƒè¯• |

---

## ğŸ¯ ä¸‹ä¸€æ­¥è¡ŒåŠ¨

1. âœ… **ç¡®è®¤æ–¹æ¡ˆ** - åˆ€ä»”è€æ¿ç¡®è®¤ä½¿ç”¨Puppeteeræ–¹æ¡ˆ
2. ğŸ“¦ **å®‰è£…ä¾èµ–** - åœ¨é¡¹ç›®ä¸­å®‰è£…Puppeteerç›¸å…³åŒ…
3. ğŸ”§ **å¼€å‘æœåŠ¡** - å®ç°DuixueqiuAutomationService
4. ğŸ§ª **æœ¬åœ°æµ‹è¯•** - åœ¨æœ¬åœ°ç¯å¢ƒæµ‹è¯•ç™»å½•å’Œå‘å¸ƒæµç¨‹
5. ğŸš€ **éƒ¨ç½²ä¸Šçº¿** - éƒ¨ç½²åˆ°ç”Ÿäº§æœåŠ¡å™¨
6. ğŸ“Š **ç›‘æ§ä¼˜åŒ–** - ç›‘æ§è¿è¡ŒçŠ¶æ€ï¼ŒæŒç»­ä¼˜åŒ–

---

**æ€»ç»“ï¼šä¸éœ€è¦ä¾èµ–å½±åˆ€RPAï¼Œä½¿ç”¨Puppeteerå®Œå…¨å¯ä»¥å®ç°å †é›ªçƒç³»ç»Ÿçš„è‡ªåŠ¨åŒ–æ“ä½œï¼**

