# è„šæœ¬2: å¾®ä¿¡å¥½å‹è§¦è¾¾

[â† è¿”å›README](./README.md)

---

## ğŸ¯ åŠŸèƒ½æ¦‚è¿°

æ‰¹é‡å‘é€æ¶ˆæ¯ç»™æ‰€æœ‰å¾®ä¿¡å¥½å‹,æ”¯æŒ**å››ç§æ¶ˆæ¯ç±»å‹**:æ–‡å­—æ¶ˆæ¯ã€è§†é¢‘å·å¡ç‰‡ã€é“¾æ¥å¡ç‰‡ã€å›¾ç‰‡æ¶ˆæ¯,ä»¥åŠ**ç»„åˆå‘é€**(åŒæ—¶å‘é€å¤šç§ç±»å‹)ã€‚æ”¯æŒå¤šè´¦å·è½®è¯¢ã€æ™ºèƒ½é—´éš”ã€æ—¶é—´æ§åˆ¶ã€æ¶ˆæ¯ä¸ªæ€§åŒ–ã€**é˜²é‡å¤å‘é€**ã€**æš‚åœ/æ¢å¤**ç­‰åŠŸèƒ½ã€‚é€‚ç”¨äºäº§å“æ¨å¹¿ã€æ´»åŠ¨é€šçŸ¥ç­‰åœºæ™¯ã€‚

### âœ¨ æ ¸å¿ƒç‰¹æ€§

- **é˜²é‡å¤å‘é€æœºåˆ¶** - åŸºäºSHA-256å“ˆå¸Œå€¼,è‡ªåŠ¨è·³è¿‡å·²å‘é€çš„æ¶ˆæ¯
- **æš‚åœ/æ¢å¤åŠŸèƒ½** - å¯éšæ—¶æš‚åœä»»åŠ¡,å…³é—­æµè§ˆå™¨,ç¨åæ¢å¤ç»§ç»­å‘é€
- **ç»„åˆå‘é€** - ä¸€æ¬¡ä»»åŠ¡å¯åŒæ—¶å‘é€æ–‡å­—+è§†é¢‘å·+é“¾æ¥+å›¾ç‰‡
- **æ™ºèƒ½å»é‡** - æ¯ç§æ¶ˆæ¯ç±»å‹ç‹¬ç«‹è®°å½•,ç²¾å‡†æ§åˆ¶å‘é€çŠ¶æ€
- **éšæœºå»¶è¿Ÿ** - æ¯æ¡æ¶ˆæ¯å‘é€å‰å¯æ·»åŠ éšæœºå»¶è¿Ÿ,æ¨¡æ‹ŸçœŸäººæ“ä½œ
- **åŒé‡åŒ¹é…** - ç´ æåŒ¹é…æ”¯æŒURLå’Œæ–‡å­—åŒé‡åŒ¹é…,æé«˜æˆåŠŸç‡

---

## ğŸ“± å››ç§æ¶ˆæ¯ç±»å‹

### 1ï¸âƒ£ æ–‡å­—æ¶ˆæ¯
- **åŠŸèƒ½**: å‘é€çº¯æ–‡æœ¬æ¶ˆæ¯ç»™å¥½å‹
- **ç‰¹æ€§**: æ”¯æŒ`{æ˜µç§°}`å˜é‡ä¸ªæ€§åŒ–
- **ç¤ºä¾‹**: "ä½ å¥½{æ˜µç§°},è¿™æ˜¯ä¸€æ¡æµ‹è¯•æ¶ˆæ¯"
- **é€‚ç”¨åœºæ™¯**: æ—¥å¸¸é—®å€™ã€æ´»åŠ¨é€šçŸ¥ã€äº§å“æ¨å¹¿

### 2ï¸âƒ£ è§†é¢‘å·æ¶ˆæ¯
- **åŠŸèƒ½**: å‘é€è§†é¢‘å·å¡ç‰‡ç»™å¥½å‹
- **ç´ ææ¥æº**: ä»å †é›ªçƒ"è§†é¢‘å·ç´ æ"åº“åŒæ­¥
- **æ•°æ®åº“è¡¨**: `duixueqiu_video_materials`
- **ç‰¹æ€§**:
  - è‡ªåŠ¨åŒæ­¥å †é›ªçƒç´ æåº“(Puppeteerçˆ¬å–)
  - å¯è§†åŒ–é€‰æ‹©ç´ æ(ç¼©ç•¥å›¾+æ ‡é¢˜)
  - æ”¯æŒé™„åŠ æ–‡æ¡ˆ,å¯ä½¿ç”¨`{æ˜µç§°}`å˜é‡
- **é€‚ç”¨åœºæ™¯**: è§†é¢‘å·æ¨å¹¿ã€å†…å®¹åˆ†äº«

### 3ï¸âƒ£ é“¾æ¥æ¶ˆæ¯
- **åŠŸèƒ½**: å‘é€å…¬ä¼—å·æ–‡ç« é“¾æ¥å¡ç‰‡ç»™å¥½å‹
- **ç´ ææ¥æº**: ä»å †é›ªçƒ"é“¾æ¥ç´ æ"åº“åŒæ­¥
- **æ•°æ®åº“è¡¨**: `duixueqiu_link_materials`
- **ç‰¹æ€§**:
  - è‡ªåŠ¨åŒæ­¥å †é›ªçƒç´ æåº“(Puppeteerçˆ¬å–)
  - å¯è§†åŒ–é€‰æ‹©ç´ æ(ç¼©ç•¥å›¾+æ ‡é¢˜+å…¬ä¼—å·åç§°)
  - æ”¯æŒé™„åŠ æ–‡æ¡ˆ,å¯ä½¿ç”¨`{æ˜µç§°}`å˜é‡
- **é€‚ç”¨åœºæ™¯**: å…¬ä¼—å·æ–‡ç« æ¨å¹¿ã€å†…å®¹åˆ†äº«

### 4ï¸âƒ£ å›¾ç‰‡æ¶ˆæ¯
- **åŠŸèƒ½**: å‘é€å›¾ç‰‡ç»™å¥½å‹
- **å›¾ç‰‡æ¥æº**: æœ¬åœ°ä¸Šä¼ æˆ–URLé“¾æ¥
- **æ•°æ®åº“è¡¨**: `follow_circle_tasks` (å­˜å‚¨å›¾ç‰‡URL)
- **ç‰¹æ€§**:
  - æ”¯æŒå¤šå¼ å›¾ç‰‡(æœ€å¤š9å¼ )
  - æ”¯æŒé¢„è§ˆå’Œåˆ é™¤
  - å›¾ç‰‡å­˜å‚¨åœ¨Supabase Storage
- **é€‚ç”¨åœºæ™¯**: äº§å“å±•ç¤ºã€æ´»åŠ¨æµ·æŠ¥ã€å›¾æ–‡æ¨å¹¿

### 5ï¸âƒ£ ç»„åˆå‘é€
- **åŠŸèƒ½**: ä¸€æ¬¡ä»»åŠ¡åŒæ—¶å‘é€å¤šç§ç±»å‹çš„æ¶ˆæ¯
- **æ”¯æŒç»„åˆ**: æ–‡å­—+è§†é¢‘å·+é“¾æ¥+å›¾ç‰‡(ä»»æ„ç»„åˆ)
- **é˜²é‡å¤æœºåˆ¶**: æ¯ç§ç±»å‹ç‹¬ç«‹è®°å½•,å·²å‘é€çš„ç±»å‹è‡ªåŠ¨è·³è¿‡
- **æš‚åœ/æ¢å¤**: æ”¯æŒæš‚åœä»»åŠ¡,ç¨åæ¢å¤ç»§ç»­å‘é€
- **é€‚ç”¨åœºæ™¯**: ç»¼åˆè¥é”€ã€å¤šå†…å®¹æ¨å¹¿

---

## ğŸ—ï¸ æŠ€æœ¯æ¶æ„

```
ç™»å½•å †é›ªçƒç³»ç»Ÿ
    â†“
è·å–æ‰€æœ‰å¾®ä¿¡å·åˆ—è¡¨
    â†“
ç‚¹å‡»"å…¨éƒ¨å¥½å‹"è·å–å¥½å‹åˆ—è¡¨
    â†“
ã€å¯é€‰ã€‘åŒæ­¥ç´ æåº“(è§†é¢‘å·/é“¾æ¥)
    â†“
è½®è¯¢å‘é€: å¾®ä¿¡1â†’å¥½å‹1, å¾®ä¿¡2â†’å¥½å‹1, å¾®ä¿¡3â†’å¥½å‹1...
    â†“
æ™ºèƒ½é—´éš” + æ—¶é—´æ§åˆ¶(8:00-22:00)
    â†“
å®æ—¶è¿›åº¦æ¨é€(WebSocket)
```

---

## ğŸ“ æ ¸å¿ƒä»£ç æ–‡ä»¶

### åç«¯

- **`pyq-backend/src/automation/wechat-reach.service.ts`**
  - `startWechatReachTask()` - ä¸»æµç¨‹å‡½æ•°(æ–‡å­—æ¶ˆæ¯)
  - `startCombinedReachTask()` - ç»„åˆå‘é€ä¸»æµç¨‹
  - `loginDuixueqiu()` - ç™»å½•å †é›ªçƒ
  - `getWechatAccounts()` - è·å–å¾®ä¿¡å·åˆ—è¡¨
  - `getFriendsList()` - è·å–å¥½å‹åˆ—è¡¨
  - `sendMessageToFriend()` - å‘é€æ–‡å­—æ¶ˆæ¯
  - `sendVideoToFriend()` - å‘é€è§†é¢‘å·å¡ç‰‡
  - `sendLinkToFriend()` - å‘é€é“¾æ¥å¡ç‰‡
  - `sendCombinedContents()` - å‘é€ç»„åˆæ¶ˆæ¯
  - `checkMessageSent()` - æ£€æŸ¥æ¶ˆæ¯æ˜¯å¦å·²å‘é€(é˜²é‡å¤)
  - `recordMessageSent()` - è®°å½•æ¶ˆæ¯å‘é€å†å²
  - `calculateMessageHash()` - è®¡ç®—æ¶ˆæ¯å†…å®¹å“ˆå¸Œå€¼
  - `pauseTask()` - æš‚åœä»»åŠ¡
  - `resumeTask()` - æ¢å¤ä»»åŠ¡
  - `isWithinSendingHours()` - æ—¶é—´æ§åˆ¶
  - `calculateInterval()` - é—´éš”è®¡ç®—

- **`pyq-backend/src/automation/video-material.service.ts`** (797è¡Œ)
  - `syncVideoMaterials()` - åŒæ­¥è§†é¢‘å·ç´ æåº“
  - `loginDuixueqiu()` - ç™»å½•å †é›ªçƒ
  - `openMaterialLibrary()` - æ‰“å¼€ç´ æåº“
  - `selectMaterialType()` - é€‰æ‹©"è§†é¢‘å·ç´ æ"
  - `extractMaterialsFromPage()` - æå–ç´ ææ•°æ®
  - `saveMaterialsToDatabase()` - ä¿å­˜åˆ°æ•°æ®åº“(å»é‡)

- **`pyq-backend/src/automation/link-material.service.ts`** (797è¡Œ)
  - `syncLinkMaterials()` - åŒæ­¥é“¾æ¥ç´ æåº“
  - å…¶ä»–å‡½æ•°ä¸`video-material.service.ts`ç›¸åŒ
  - åŒºåˆ«: é€‰æ‹©"é“¾æ¥ç´ æ"ç±»å‹,æå–ä¸åŒå­—æ®µ

- **`pyq-backend/src/automation/automation.controller.ts`**
  - `POST /api/automation/script2/wechat-reach` - å¼€å§‹ä»»åŠ¡(å•ä¸€ç±»å‹)
  - `POST /api/automation/script2/combined-reach` - å¼€å§‹ç»„åˆå‘é€ä»»åŠ¡
  - `POST /api/automation/script2/pause` - æš‚åœä»»åŠ¡
  - `POST /api/automation/script2/resume` - æ¢å¤ä»»åŠ¡
  - `POST /api/automation/script2/stop` - åœæ­¢ä»»åŠ¡
  - `POST /api/automation/script2/status` - æŸ¥è¯¢çŠ¶æ€
  - `POST /api/automation/script2/sync-video-materials` - åŒæ­¥è§†é¢‘å·ç´ æ
  - `GET /api/automation/script2/video-materials` - è·å–è§†é¢‘å·ç´ æåˆ—è¡¨
  - `POST /api/automation/script2/sync-link-materials` - åŒæ­¥é“¾æ¥ç´ æ
  - `GET /api/automation/script2/link-materials` - è·å–é“¾æ¥ç´ æåˆ—è¡¨

- **`pyq-backend/src/automation/automation.gateway.ts`**
  - `emitScript2Log()` - å‘é€æ—¥å¿—
  - `emitProgress()` - å‘é€è¿›åº¦
  - `emitScript2Complete()` - å‘é€å®Œæˆé€šçŸ¥

### å‰ç«¯

- **`pyq-frontend-vben/apps/web-antd/src/views/scripts/script2.vue`**
  - ç”¨æˆ·ç•Œé¢å’ŒWebSocketè¿æ¥
  - ä¸‰ç§æ¶ˆæ¯ç±»å‹åˆ‡æ¢(æ–‡å­—/è§†é¢‘å·/é“¾æ¥)
  - ç´ æåº“åŒæ­¥å’Œé€‰æ‹©ç•Œé¢
  - ä»»åŠ¡æ§åˆ¶(å¼€å§‹/æš‚åœ/æ¢å¤/åœæ­¢)

---

## ğŸ”Œ APIæ¥å£

### 1. å¼€å§‹ä»»åŠ¡

```typescript
POST /api/automation/script2/wechat-reach
Content-Type: application/json

// æ–‡å­—æ¶ˆæ¯
{
  "userId": "ç”¨æˆ·UUID",
  "messageType": "text",
  "message": "ä½ å¥½{æ˜µç§°},è¿™æ˜¯ä¸€æ¡æµ‹è¯•æ¶ˆæ¯",
  "targetDays": 7,
  "taskId": "task_123456"
}

// è§†é¢‘å·æ¶ˆæ¯
{
  "userId": "ç”¨æˆ·UUID",
  "messageType": "video",
  "materialId": 123,         // è§†é¢‘å·ç´ æID
  "additionalText": "æ¨èç»™ä½ {æ˜µç§°}",  // å¯é€‰é™„åŠ æ–‡æ¡ˆ
  "targetDays": 7,
  "taskId": "task_123456"
}

// é“¾æ¥æ¶ˆæ¯
{
  "userId": "ç”¨æˆ·UUID",
  "messageType": "link",
  "materialId": 456,         // é“¾æ¥ç´ æID
  "additionalText": "åˆ†äº«ç»™ä½ {æ˜µç§°}",  // å¯é€‰é™„åŠ æ–‡æ¡ˆ
  "targetDays": 7,
  "taskId": "task_123456"
}

// è¿”å›
{
  "success": true,
  "message": "ä»»åŠ¡å·²å¯åŠ¨"
}
```

### 2. åŒæ­¥ç´ æåº“

```typescript
// åŒæ­¥è§†é¢‘å·ç´ æ
POST /api/automation/script2/sync-video-materials
Content-Type: application/json

{
  "userId": "ç”¨æˆ·UUID"
}

// è¿”å›
{
  "success": true,
  "message": "åŒæ­¥æˆåŠŸ",
  "count": 39  // åŒæ­¥çš„ç´ ææ•°é‡
}

// åŒæ­¥é“¾æ¥ç´ æ
POST /api/automation/script2/sync-link-materials
Content-Type: application/json

{
  "userId": "ç”¨æˆ·UUID"
}

// è¿”å›
{
  "success": true,
  "message": "åŒæ­¥æˆåŠŸ",
  "count": 25
}
```

### 3. è·å–ç´ æåˆ—è¡¨

```typescript
// è·å–è§†é¢‘å·ç´ æ
GET /api/automation/script2/video-materials?userId={userId}

// è¿”å›
{
  "success": true,
  "data": [
    {
      "id": 1,
      "userId": "uuid",
      "authorName": "ä½œè€…åç§°",
      "contentDesc": "è§†é¢‘æè¿°",
      "thumbnailUrl": "ç¼©ç•¥å›¾URL",
      "materialIndex": 0,
      "pageNumber": 1,
      "syncTime": "2025-11-11T10:00:00.000Z"
    }
  ]
}

// è·å–é“¾æ¥ç´ æ
GET /api/automation/script2/link-materials?userId={userId}

// è¿”å›
{
  "success": true,
  "data": [
    {
      "id": 1,
      "userId": "uuid",
      "title": "æ–‡ç« æ ‡é¢˜",
      "accountName": "å…¬ä¼—å·åç§°",
      "thumbnailUrl": "ç¼©ç•¥å›¾URL",
      "linkUrl": "æ–‡ç« é“¾æ¥",
      "materialIndex": 0,
      "pageNumber": 1,
      "syncTime": "2025-11-11T10:00:00.000Z"
    }
  ]
}
```

### 4. æš‚åœ/æ¢å¤/åœæ­¢ä»»åŠ¡

```typescript
POST /api/automation/script2/pause
POST /api/automation/script2/resume
POST /api/automation/script2/stop
Content-Type: application/json

{
  "taskId": "task_123456"
}
```

### 5. WebSocketå®æ—¶æ¨é€

```typescript
// è¿æ¥
ws://localhost:3000/automation/ws/{taskId}

// æ¥æ”¶æ—¥å¿—
{
  "event": "script2Log",
  "data": {
    "taskId": "task_123456",
    "log": "æ­£åœ¨å‘é€æ¶ˆæ¯ç»™å¥½å‹: å¼ ä¸‰",
    "timestamp": "2025-11-07T10:00:00.000Z"
  }
}

// æ¥æ”¶è¿›åº¦
{
  "event": "script2Progress",
  "data": {
    "taskId": "task_123456",
    "sentCount": 10,
    "totalFriends": 100,
    "currentFriend": "å¼ ä¸‰",
    "currentWechat": "å¾®ä¿¡1",
    "progress": 10
  }
}

// æ¥æ”¶å®Œæˆé€šçŸ¥
{
  "event": "script2Complete",
  "data": {
    "taskId": "task_123456",
    "success": true,
    "message": "ä»»åŠ¡å®Œæˆ"
  }
}
```

---

## ï¿½ï¸ æ•°æ®åº“è¡¨ç»“æ„

### 1. duixueqiu_video_materials (è§†é¢‘å·ç´ æè¡¨)

```sql
CREATE TABLE duixueqiu_video_materials (
  id SERIAL PRIMARY KEY,
  user_id UUID NOT NULL,              -- ç”¨æˆ·ID (å…³è”usersè¡¨)
  author_name VARCHAR(200),            -- è§†é¢‘å·ä½œè€…åç§°
  content_desc TEXT,                   -- è§†é¢‘æè¿°
  thumbnail_url TEXT,                  -- ç¼©ç•¥å›¾URL
  material_index INT,                  -- ç´ æåœ¨åˆ—è¡¨ä¸­çš„ç´¢å¼•ä½ç½®
  page_number INT DEFAULT 1,           -- ç´ ææ‰€åœ¨é¡µç 
  sync_time TIMESTAMP DEFAULT NOW(),   -- æœ€ååŒæ­¥æ—¶é—´
  create_time TIMESTAMP DEFAULT NOW(), -- åˆ›å»ºæ—¶é—´
  UNIQUE(user_id, thumbnail_url)       -- å»é‡çº¦æŸ
);

-- ç´¢å¼•
CREATE INDEX idx_duixueqiu_video_materials_user_id ON duixueqiu_video_materials(user_id);
CREATE INDEX idx_duixueqiu_video_materials_sync_time ON duixueqiu_video_materials(sync_time);

-- å¤–é”®çº¦æŸ
ALTER TABLE duixueqiu_video_materials
  ADD CONSTRAINT fk_duixueqiu_video_materials_user_id
  FOREIGN KEY (user_id) REFERENCES users(id) ON DELETE CASCADE;
```

**å­—æ®µè¯´æ˜:**
- `user_id`: ç”¨æˆ·UUID,å…³è”åˆ°`users`è¡¨
- `author_name`: è§†é¢‘å·ä½œè€…åç§°
- `content_desc`: è§†é¢‘å†…å®¹æè¿°
- `thumbnail_url`: è§†é¢‘ç¼©ç•¥å›¾URL,ç”¨äºå»é‡
- `material_index`: ç´ æåœ¨å †é›ªçƒç´ æåº“ä¸­çš„ç´¢å¼•ä½ç½®(ç”¨äºå®šä½ç‚¹å‡»)
- `page_number`: ç´ ææ‰€åœ¨é¡µç (ç”¨äºç¿»é¡µ)
- `sync_time`: æœ€ååŒæ­¥æ—¶é—´,ç”¨äºåˆ¤æ–­æ˜¯å¦éœ€è¦é‡æ–°åŒæ­¥

### 2. duixueqiu_link_materials (é“¾æ¥ç´ æè¡¨)

```sql
CREATE TABLE duixueqiu_link_materials (
  id SERIAL PRIMARY KEY,
  user_id UUID NOT NULL,              -- ç”¨æˆ·ID (å…³è”usersè¡¨)
  title VARCHAR(500) NOT NULL,         -- æ–‡ç« æ ‡é¢˜
  account_name TEXT,                   -- å…¬ä¼—å·åç§°
  thumbnail_url TEXT,                  -- ç¼©ç•¥å›¾URL
  link_url TEXT,                       -- æ–‡ç« é“¾æ¥URL
  material_index INT,                  -- ç´ æåœ¨åˆ—è¡¨ä¸­çš„ç´¢å¼•ä½ç½®
  page_number INT DEFAULT 1,           -- ç´ ææ‰€åœ¨é¡µç 
  sync_time TIMESTAMP DEFAULT NOW(),   -- æœ€ååŒæ­¥æ—¶é—´
  create_time TIMESTAMP DEFAULT NOW(), -- åˆ›å»ºæ—¶é—´
  UNIQUE(user_id, thumbnail_url)       -- å»é‡çº¦æŸ
);

-- ç´¢å¼•
CREATE INDEX idx_duixueqiu_link_materials_user_id ON duixueqiu_link_materials(user_id);
CREATE INDEX idx_duixueqiu_link_materials_title ON duixueqiu_link_materials(title);
CREATE INDEX idx_duixueqiu_link_materials_sync_time ON duixueqiu_link_materials(sync_time);

-- å¤–é”®çº¦æŸ
ALTER TABLE duixueqiu_link_materials
  ADD CONSTRAINT fk_duixueqiu_link_materials_user_id
  FOREIGN KEY (user_id) REFERENCES users(id) ON DELETE CASCADE;
```

**å­—æ®µè¯´æ˜:**
- `user_id`: ç”¨æˆ·UUID,å…³è”åˆ°`users`è¡¨
- `title`: æ–‡ç« æ ‡é¢˜
- `account_name`: å…¬ä¼—å·åç§°(TEXTç±»å‹,æ— é•¿åº¦é™åˆ¶)
- `thumbnail_url`: æ–‡ç« ç¼©ç•¥å›¾URL,ç”¨äºå»é‡
- `link_url`: æ–‡ç« é“¾æ¥URL
- `material_index`: ç´ æåœ¨å †é›ªçƒç´ æåº“ä¸­çš„ç´¢å¼•ä½ç½®
- `page_number`: ç´ ææ‰€åœ¨é¡µç 
- `sync_time`: æœ€ååŒæ­¥æ—¶é—´

**æ•°æ®åº“è®¾è®¡è¦ç‚¹:**
1. **UUIDç±»å‹**: `user_id`ä½¿ç”¨UUIDç±»å‹,ä¸`users`è¡¨ä¿æŒä¸€è‡´
2. **TEXTç±»å‹**: `account_name`ä½¿ç”¨TEXTç±»å‹,é¿å…å…¬ä¼—å·åç§°è¿‡é•¿å¯¼è‡´æˆªæ–­
3. **å»é‡çº¦æŸ**: ä½¿ç”¨`UNIQUE(user_id, thumbnail_url)`é¿å…é‡å¤åŒæ­¥
4. **çº§è”åˆ é™¤**: ç”¨æˆ·åˆ é™¤æ—¶è‡ªåŠ¨åˆ é™¤å…³è”çš„ç´ ææ•°æ®
5. **ç´¢å¼•ä¼˜åŒ–**: åœ¨å¸¸ç”¨æŸ¥è¯¢å­—æ®µä¸Šåˆ›å»ºç´¢å¼•,æé«˜æŸ¥è¯¢æ€§èƒ½

---

## ï¿½ğŸ“Š æ•°æ®æµç¨‹

### æ­¥éª¤1: ç™»å½•å †é›ªçƒ (loginDuixueqiu)

- è®¿é—® `https://dxqscrm.duixueqiu.cn/`
- è¾“å…¥è´¦å·å¯†ç : `lifangde001 / Lfd666888#`
- ç­‰å¾…ç™»å½•æˆåŠŸ

### æ­¥éª¤2: è·å–å¾®ä¿¡å·åˆ—è¡¨ (getWechatAccounts)

- ç‚¹å‡»"å¾®ä¿¡å·ç®¡ç†"
- æå–æ‰€æœ‰å¾®ä¿¡å·IDå’Œåç§°
- è¿”å›æ•°ç»„: `[{id, name}]`

### æ­¥éª¤3: è·å–å¥½å‹åˆ—è¡¨ (getFriendsList)

- ç‚¹å‡»"å…¨éƒ¨å¥½å‹"(ä¸æ˜¯"æœªåˆ†ç»„")
- ç‚¹å‡»"å¥½å‹åˆ—è¡¨"æ ‡ç­¾
- æ»šåŠ¨åŠ è½½æ‰€æœ‰å¥½å‹
- æå–å¥½å‹IDå’Œæ˜µç§°

### æ­¥éª¤4: è½®è¯¢å‘é€ (sendMessageToFriend)

- åˆ‡æ¢å¾®ä¿¡å·: `switchWechatAccount()`
- ç‚¹å‡»å¥½å‹
- è¾“å…¥æ¶ˆæ¯(æ›¿æ¢{æ˜µç§°}å˜é‡)
- ç‚¹å‡»å‘é€
- ç­‰å¾…é—´éš”æ—¶é—´

### æ­¥éª¤5: æ—¶é—´æ§åˆ¶ (isWithinSendingHours)

- æ£€æŸ¥å½“å‰æ—¶é—´æ˜¯å¦åœ¨8:00-22:00
- å¦‚æœä¸åœ¨,æš‚åœå¹¶ç­‰å¾…æ¬¡æ—¥8:00
- ä¿å­˜è¿›åº¦,æ¬¡æ—¥è‡ªåŠ¨æ¢å¤

---

## ğŸ”‘ å…³é”®æŠ€æœ¯ç‚¹

### 1. é˜²é‡å¤å‘é€æœºåˆ¶

**æ ¸å¿ƒåŸç†**: åŸºäºSHA-256å“ˆå¸Œå€¼çš„æ¶ˆæ¯å»é‡ç³»ç»Ÿ

**å®ç°ç»†èŠ‚**:
```typescript
// 1. è®¡ç®—æ¶ˆæ¯å†…å®¹å“ˆå¸Œå€¼
private calculateMessageHash(messageType: string, messageContent: any): string {
  const crypto = require('crypto');
  const contentStr = JSON.stringify({ type: messageType, content: messageContent });
  return crypto.createHash('sha256').update(contentStr).digest('hex');
}

// 2. æ£€æŸ¥æ¶ˆæ¯æ˜¯å¦å·²å‘é€
private async checkMessageSent(
  userId: string,      // ç”¨æˆ·UUID
  friendId: number,    // å¥½å‹ID(BIGINT)
  messageType: string, // æ¶ˆæ¯ç±»å‹
  messageContent: any  // æ¶ˆæ¯å†…å®¹
): Promise<boolean> {
  const contentHash = this.calculateMessageHash(messageType, messageContent);

  const { data } = await this.supabaseService.getClient()
    .from('message_send_history')
    .select('id')
    .eq('user_id', userId)
    .eq('friend_id', friendId)
    .eq('message_content_hash', contentHash)
    .limit(1);

  return data && data.length > 0;
}

// 3. è®°å½•æ¶ˆæ¯å‘é€å†å²
private async recordMessageSent(
  userId: string,
  friendId: number,
  friendName: string,
  messageType: string,
  messageContent: any,
  taskId?: string
): Promise<void> {
  const contentHash = this.calculateMessageHash(messageType, messageContent);

  await this.supabaseService.getClient()
    .from('message_send_history')
    .insert({
      user_id: userId,
      friend_id: friendId,
      friend_name: friendName,
      message_type: messageType,
      message_content_hash: contentHash,
      message_content: messageContent,
      task_id: taskId,
      sent_at: new Date().toISOString()
    });
}
```

**æ•°æ®åº“è¡¨**: `message_send_history`
- `user_id` (UUID) - ç”¨æˆ·ID
- `friend_id` (BIGINT) - å¥½å‹ID
- `message_type` (TEXT) - æ¶ˆæ¯ç±»å‹(text/video/link/image/combined)
- `message_content_hash` (TEXT) - SHA-256å“ˆå¸Œå€¼
- `message_content` (JSONB) - å®Œæ•´æ¶ˆæ¯å†…å®¹
- `sent_at` (TIMESTAMP) - å‘é€æ—¶é—´

**ç´¢å¼•ä¼˜åŒ–**:
```sql
CREATE INDEX idx_message_send_history_lookup
ON message_send_history(user_id, friend_id, message_content_hash);
```

**å·¥ä½œæµç¨‹**:
1. å‘é€å‰è°ƒç”¨`checkMessageSent()`æ£€æŸ¥æ˜¯å¦å·²å‘é€
2. å¦‚æœå·²å‘é€,è·³è¿‡è¯¥å¥½å‹
3. å¦‚æœæœªå‘é€,å‘é€æ¶ˆæ¯åè°ƒç”¨`recordMessageSent()`è®°å½•
4. ç»„åˆå‘é€æ—¶,æ¯ç§ç±»å‹ç‹¬ç«‹æ£€æŸ¥å’Œè®°å½•

---

### 2. æš‚åœ/æ¢å¤åŠŸèƒ½

**æ ¸å¿ƒåŸç†**: åˆ©ç”¨é˜²é‡å¤å‘é€æœºåˆ¶,æš‚åœåé‡æ–°è°ƒç”¨ä¸»å‡½æ•°,è‡ªåŠ¨è·³è¿‡å·²å‘é€çš„æ¶ˆæ¯

**å®ç°ç»†èŠ‚**:
```typescript
// æš‚åœä»»åŠ¡
async pauseTask(): Promise<void> {
  this.isPaused = true;
  this.isRunning = false;

  // å…³é—­æµè§ˆå™¨,é‡Šæ”¾å †é›ªçƒè´¦å·
  if (this.browser) {
    await this.browser.close();
    this.browser = null;
  }

  // ä¿ç•™ä»»åŠ¡å‚æ•°,ç”¨äºæ¢å¤
  // this.currentTaskParams åŒ…å«æ‰€æœ‰ä»»åŠ¡é…ç½®
}

// æ¢å¤ä»»åŠ¡
async resumeTask(): Promise<void> {
  if (!this.currentTaskParams) {
    throw new Error('æ²¡æœ‰å¯æ¢å¤çš„ä»»åŠ¡');
  }

  this.isPaused = false;

  // é‡æ–°è°ƒç”¨ä¸»å‡½æ•°,é˜²é‡å¤æœºåˆ¶ä¼šè‡ªåŠ¨è·³è¿‡å·²å‘é€çš„æ¶ˆæ¯
  if (this.currentTaskParams.taskType === 'combined') {
    await this.startCombinedReachTask(
      this.currentTaskParams.contents,
      this.currentTaskParams.targetDays,
      this.currentTaskParams.userId,
      this.currentTaskParams.taskId,
      this.currentTaskParams.forbiddenTimeRanges,
      this.currentTaskParams.selectedWechatAccountIndexes,
      this.currentTaskParams.selectedFriendIds
    );
  } else {
    // å•ä¸€ç±»å‹ä»»åŠ¡æ¢å¤é€»è¾‘
  }
}
```

**å…³é”®ç‚¹**:
- æš‚åœæ—¶ä¿å­˜`currentTaskParams`(ä»»åŠ¡é…ç½®)
- æ¢å¤æ—¶é‡æ–°è°ƒç”¨ä¸»å‡½æ•°,ä¼ å…¥ç›¸åŒå‚æ•°
- ä¾èµ–`checkMessageSent()`è‡ªåŠ¨è·³è¿‡å·²å‘é€çš„æ¶ˆæ¯
- æ— éœ€æ‰‹åŠ¨è®°å½•è¿›åº¦,å®Œå…¨ä¾èµ–æ•°æ®åº“è®°å½•

**ç”¨æˆ·ä½“éªŒ**:
1. ç”¨æˆ·ç‚¹å‡»"æš‚åœ"æŒ‰é’®
2. ç³»ç»Ÿå…³é—­æµè§ˆå™¨,é‡Šæ”¾èµ„æº
3. ç”¨æˆ·å¯ä»¥å…³é—­ç”µè„‘,ç¨åå›æ¥
4. ç”¨æˆ·ç‚¹å‡»"æ¢å¤"æŒ‰é’®
5. ç³»ç»Ÿé‡æ–°ç™»å½•,ä»æœªå‘é€çš„å¥½å‹ç»§ç»­

---

### 3. éšæœºå»¶è¿ŸåŠŸèƒ½

**æ ¸å¿ƒåŸç†**: åœ¨æ¯æ¡æ¶ˆæ¯å‘é€å‰æ·»åŠ éšæœºå»¶è¿Ÿ,æ¨¡æ‹ŸçœŸäººæ“ä½œ,é¿å…è¢«æ£€æµ‹ä¸ºæœºå™¨äºº

**å®ç°ç»†èŠ‚**:
```typescript
// åœ¨å‘é€æ¯æ¡æ¶ˆæ¯å‰æ·»åŠ éšæœºå»¶è¿Ÿ
for (let i = 0; i < sortedContents.length; i++) {
  const content = sortedContents[i];

  // ğŸ†• éšæœºå»¶è¿Ÿ(åœ¨æ¯æ¡æ¶ˆæ¯å‘é€å‰,é™¤äº†ç¬¬ä¸€æ¡)
  if (i > 0 && randomDelay?.enabled) {
    const minDelay = randomDelay.minDelay || 3;
    const maxDelay = randomDelay.maxDelay || 10;
    const delay = minDelay + Math.random() * (maxDelay - minDelay);
    this.emitLog(`â³ éšæœºå»¶è¿Ÿ: ${delay.toFixed(1)} ç§’...`);
    await new Promise(resolve => setTimeout(resolve, delay * 1000));
  }

  // å‘é€æ¶ˆæ¯
  switch (content.type) {
    case 'text':
      await this.sendMessageToFriendDirect(page, friendName, content.message);
      break;
    case 'video':
      await this.sendVideoMaterialDirect(page, content.materialId);
      break;
    // ...
  }
}
```

**é…ç½®å‚æ•°**:
- `enabled` (boolean) - æ˜¯å¦å¯ç”¨éšæœºå»¶è¿Ÿ
- `minDelay` (number) - æœ€å°å»¶è¿Ÿæ—¶é—´(ç§’),é»˜è®¤3ç§’
- `maxDelay` (number) - æœ€å¤§å»¶è¿Ÿæ—¶é—´(ç§’),é»˜è®¤10ç§’

**å‰ç«¯UI**:
- ä½ç½®: "å‘é€ç­–ç•¥é…ç½®"å¡ç‰‡
- æ§ä»¶: å¤é€‰æ¡†(å¯ç”¨/ç¦ç”¨) + ä¸¤ä¸ªæ•°å­—è¾“å…¥æ¡†(æœ€å°/æœ€å¤§å»¶è¿Ÿ)
- å®æ—¶æç¤º: æ˜¾ç¤ºå½“å‰å»¶è¿ŸèŒƒå›´(å¦‚"æ¯æ¡æ¶ˆæ¯é—´éš” 3-10 ç§’")

**ä½¿ç”¨åœºæ™¯**:
- å¤§æ‰¹é‡å‘é€æ—¶,é¿å…è¢«å¾®ä¿¡æ£€æµ‹ä¸ºæœºå™¨äºº
- æ¨¡æ‹ŸçœŸäººæ“ä½œ,æé«˜å‘é€æˆåŠŸç‡
- å¯æ ¹æ®éœ€è¦è°ƒæ•´å»¶è¿ŸèŒƒå›´(å¦‚é«˜å³°æœŸå¢åŠ å»¶è¿Ÿ)

---

### 4. åŒé‡åŒ¹é…æœºåˆ¶

**æ ¸å¿ƒåŸç†**: ç´ æåŒ¹é…æ”¯æŒURLå’Œæ–‡å­—åŒé‡åŒ¹é…,æé«˜åŒ¹é…æˆåŠŸç‡,é¿å…å› ç´ æåº“ä¸åŒæ­¥å¯¼è‡´å‘é€å¤±è´¥

#### è§†é¢‘å·ç´ æåŒé‡åŒ¹é…

**ä¼˜å…ˆçº§**: ç¼©ç•¥å›¾URLç²¾ç¡®åŒ¹é… > ä½œè€…å+æè¿°æ–‡å­—åŒ¹é…

```typescript
const matchResult = await page.evaluate((targetThumbnail, targetAuthor, targetDesc) => {
  const materialCards = document.querySelectorAll('.materials-link-wrap');

  for (let i = 0; i < materialCards.length; i++) {
    const card = materialCards[i];

    // è·å–ç¼©ç•¥å›¾URL
    const imgElement = card.querySelector('[class*="img-wrap"] img');
    const thumbnailUrl = imgElement?.getAttribute('src') || '';

    // è·å–ä½œè€…åå’Œæè¿°
    const titleElement = card.querySelector('[class*="text-title"]');
    const authorName = titleElement?.getAttribute('title') || '';
    const descElement = card.querySelector('[class*="text-desc"]');
    const contentDesc = descElement?.textContent?.trim() || '';

    // ğŸ†• åŒé‡åŒ¹é…: ä¼˜å…ˆç¼©ç•¥å›¾URL,å¤‡ç”¨ä½œè€…å+æè¿°
    const thumbnailMatch = thumbnailUrl === targetThumbnail;
    const textMatch = authorName === targetAuthor && contentDesc.includes(targetDesc.substring(0, 20));

    if (thumbnailMatch || textMatch) {
      // åŒ¹é…æˆåŠŸ,ç‚¹å‡»ç´ æ
      const confirmIcons = document.querySelectorAll('.confirm-icon');
      if (confirmIcons[i]) {
        (confirmIcons[i] as HTMLElement).click();
        return {
          found: true,
          matchType: thumbnailMatch ? 'thumbnail' : 'text'
        };
      }
    }
  }
  return { found: false };
}, material.thumbnail_url, material.author_name, material.content_desc || '');
```

#### é“¾æ¥ç´ æåŒé‡åŒ¹é…

**ä¼˜å…ˆçº§**: æ ‡é¢˜+å…¬ä¼—å·åç§°ç²¾ç¡®åŒ¹é… > æ ‡é¢˜å‰30å­—ç¬¦+å…¬ä¼—å·åç§°æ¨¡ç³ŠåŒ¹é…

```typescript
const matchResult = await page.evaluate((targetTitle, targetAccount) => {
  const materialCards = document.querySelectorAll('.materials-link-wrap');

  for (let i = 0; i < materialCards.length; i++) {
    const card = materialCards[i];
    const titleElement = card.querySelector('[class*="text-title"]');
    const title = titleElement?.getAttribute('title') || titleElement?.textContent?.trim() || '';
    const accountElement = card.querySelector('[class*="text-desc"]');
    const accountName = accountElement?.textContent?.trim() || '';

    // ğŸ†• åŒé‡åŒ¹é…: ä¼˜å…ˆç²¾ç¡®åŒ¹é…,å¤‡ç”¨æ¨¡ç³ŠåŒ¹é…(æ ‡é¢˜å‰30å­—ç¬¦+å…¬ä¼—å·åç§°)
    const exactMatch = title === targetTitle && accountName === targetAccount;
    const fuzzyMatch = title.substring(0, 30) === targetTitle.substring(0, 30) && accountName === targetAccount;

    if (exactMatch || fuzzyMatch) {
      // åŒ¹é…æˆåŠŸ,ç‚¹å‡»ç´ æ
      const confirmIcons = document.querySelectorAll('.confirm-icon');
      if (confirmIcons[i]) {
        (confirmIcons[i] as HTMLElement).click();
        return {
          found: true,
          matchType: exactMatch ? 'exact' : 'fuzzy'
        };
      }
    }
  }
  return { found: false };
}, material.title, material.account_name);
```

**ä¼˜åŠ¿**:
- **æé«˜æˆåŠŸç‡**: å³ä½¿ç¼©ç•¥å›¾URLå˜åŒ–,ä»å¯é€šè¿‡æ–‡å­—åŒ¹é…
- **å®¹é”™æ€§å¼º**: æ”¯æŒæ¨¡ç³ŠåŒ¹é…,é¿å…å› æ ‡é¢˜å¾®å°å·®å¼‚å¯¼è‡´å¤±è´¥
- **æ— éœ€é¢‘ç¹åŒæ­¥**: å‡å°‘å¯¹ç´ æåº“åŒæ­¥çš„ä¾èµ–

**æ—¥å¿—è¾“å‡º**:
```
âœ… æ‰¾åˆ°åŒ¹é…çš„ç´ æ: ä½œè€…å - æè¿°...
ğŸ” åŒ¹é…æ–¹å¼: ç¼©ç•¥å›¾URL / ä½œè€…å+æè¿° / ç²¾ç¡®åŒ¹é… / æ¨¡ç³ŠåŒ¹é…(å‰30å­—ç¬¦)
```

---

### 5. è§†é¢‘å·ç´ æé€‰æ‹©çš„Puppeteerå®ç°

è§†é¢‘å·ç´ æé€‰æ‹©æ˜¯æ•´ä¸ªåŠŸèƒ½ä¸­æœ€å¤æ‚çš„éƒ¨åˆ†,æ¶‰åŠå¤šå±‚å¯¹è¯æ¡†å’Œç²¾ç¡®çš„å…ƒç´ å®šä½ã€‚

#### æ ¸å¿ƒæŒ‘æˆ˜

1. **å¤šå±‚å¯¹è¯æ¡†åŒºåˆ†**: å †é›ªçƒç³»ç»Ÿæœ‰ä¸»å¯¹è¯æ¡†å’Œå¾®å°å·é€‰æ‹©å¯¹è¯æ¡†,éœ€è¦ç²¾ç¡®åŒºåˆ†
2. **æŒ‰é’®æ–‡æœ¬å·®å¼‚**: ä¸»å¯¹è¯æ¡†çš„"ç¡®å®š"æŒ‰é’®å’Œå¾®å°å·å¯¹è¯æ¡†çš„"ç¡® å®š"æŒ‰é’®(ä¸­é—´æœ‰ç©ºæ ¼)
3. **Element UIç»„ä»¶**: éœ€è¦ç†è§£Element UIçš„DOMç»“æ„å’Œç±»åè§„åˆ™

#### å®Œæ•´æµç¨‹(11ä¸ªæ­¥éª¤)

```typescript
// æ­¥éª¤1: æ‰“å¼€ç´ æåº“
await page.click('a[href="#/material/library"]');
await page.waitForSelector('.material-library-container', { timeout: 10000 });

// æ­¥éª¤2: é€‰æ‹©"è§†é¢‘å·ç´ æ"ç±»å‹
await page.evaluate(() => {
  const buttons = document.querySelectorAll('button');
  for (const button of buttons) {
    if (button.textContent?.includes('è§†é¢‘å·ç´ æ')) {
      button.click();
      return;
    }
  }
});

// æ­¥éª¤3-11: é€‰æ‹©ç´ æå¹¶å‘é€
// (è¯¦è§ä¸‹æ–¹"ç´ æé€‰æ‹©æ ¸å¿ƒä»£ç ")
```

#### ç´ æé€‰æ‹©æ ¸å¿ƒä»£ç 

**å…³é”®æŠ€æœ¯: é¼ æ ‡æ¨¡æ‹Ÿç‚¹å‡» + Element UIé€‰æ‹©å™¨ä¼˜å…ˆçº§**

```typescript
// âœ… æ­£ç¡®æ–¹æ³•: ä½¿ç”¨é¼ æ ‡æ¨¡æ‹Ÿç‚¹å‡»
async selectVideoMaterial(page, materialIndex) {
  // 1. è·å–ç´ æå…ƒç´ çš„åæ ‡
  const coordinates = await page.evaluate((index) => {
    const items = document.querySelectorAll('.material-item');
    const item = items[index];
    if (!item) return null;

    const rect = item.getBoundingClientRect();
    return {
      x: rect.left + rect.width / 2,
      y: rect.top + rect.height / 2
    };
  }, materialIndex);

  // 2. ä½¿ç”¨é¼ æ ‡ç§»åŠ¨å¹¶ç‚¹å‡»
  await page.mouse.move(coordinates.x, coordinates.y);
  await page.mouse.click(coordinates.x, coordinates.y);

  // 3. ç­‰å¾…å¯¹è¯æ¡†å‡ºç°
  await page.waitForSelector('.el-dialog__wrapper', { visible: true });

  // 4. ç‚¹å‡»"å‘é€ç»™å¥½å‹"æŒ‰é’® (ä¼˜å…ˆé€‰æ‹©.el-button--success)
  await page.evaluate(() => {
    // ä¼˜å…ˆæŸ¥æ‰¾ç»¿è‰²æŒ‰é’®(Element UIçš„successç±»å‹)
    const successButton = document.querySelector('button.el-button--success');
    if (successButton && successButton.textContent?.includes('å‘é€ç»™å¥½å‹')) {
      successButton.click();
      return;
    }

    // å¤‡é€‰: æŸ¥æ‰¾æ‰€æœ‰æŒ‰é’®
    const buttons = document.querySelectorAll('button');
    for (const button of buttons) {
      if (button.textContent?.includes('å‘é€ç»™å¥½å‹')) {
        button.click();
        return;
      }
    }
  });

  // 5. ç­‰å¾…å¾®å°å·é€‰æ‹©å¯¹è¯æ¡†å‡ºç°
  await page.waitForFunction(() => {
    const dialogs = document.querySelectorAll('.el-dialog__wrapper');
    for (const dialog of dialogs) {
      const title = dialog.querySelector('.el-dialog__title');
      if (title?.textContent?.includes('é€‰æ‹©å¾®å°å·')) {
        return true;
      }
    }
    return false;
  }, { timeout: 5000 });

  // 6. åœ¨å¾®å°å·å¯¹è¯æ¡†ä¸­ç‚¹å‡»"ç¡® å®š"æŒ‰é’®(æ³¨æ„ä¸­é—´æœ‰ç©ºæ ¼)
  await page.evaluate(() => {
    // æŸ¥æ‰¾åŒ…å«"é€‰æ‹©å¾®å°å·"æ ‡é¢˜çš„å¯¹è¯æ¡†
    const dialogs = document.querySelectorAll('.el-dialog__wrapper');
    for (const dialog of dialogs) {
      const title = dialog.querySelector('.el-dialog__title');
      if (title?.textContent?.includes('é€‰æ‹©å¾®å°å·')) {
        // åœ¨footerä¸­æŸ¥æ‰¾"ç¡® å®š"æŒ‰é’®(ä¸­é—´æœ‰ç©ºæ ¼)
        const footer = dialog.querySelector('.el-dialog__footer');
        if (footer) {
          const buttons = footer.querySelectorAll('button');
          for (const button of buttons) {
            const text = button.textContent?.trim();
            // å…³é”®: åŒ¹é…"ç¡® å®š"(ä¸­é—´æœ‰ç©ºæ ¼),è€Œä¸æ˜¯"ç¡®å®š"
            if (text === 'ç¡® å®š' || text?.includes('ç¡®') && text?.includes('å®š')) {
              button.click();
              return;
            }
          }
        }
      }
    }
  });
}
```

#### å…³é”®æŠ€æœ¯è¦ç‚¹

**1. é¼ æ ‡æ¨¡æ‹Ÿç‚¹å‡» vs ç›´æ¥element.click()**

```typescript
// âŒ é”™è¯¯æ–¹æ³•: ç›´æ¥ç‚¹å‡»å¯èƒ½å¤±è´¥
await page.evaluate((index) => {
  const items = document.querySelectorAll('.material-item');
  items[index].click(); // å¯èƒ½è¢«å…¶ä»–å…ƒç´ é®æŒ¡
}, materialIndex);

// âœ… æ­£ç¡®æ–¹æ³•: ä½¿ç”¨é¼ æ ‡æ¨¡æ‹Ÿ
const rect = await page.evaluate((index) => {
  const item = document.querySelectorAll('.material-item')[index];
  const rect = item.getBoundingClientRect();
  return { x: rect.left + rect.width / 2, y: rect.top + rect.height / 2 };
}, materialIndex);

await page.mouse.move(rect.x, rect.y);
await page.mouse.click(rect.x, rect.y);
```

**2. Element UIæŒ‰é’®é€‰æ‹©å™¨ä¼˜å…ˆçº§**

```typescript
// ä¼˜å…ˆçº§1: ä½¿ç”¨Element UIçš„ç±»å‹ç±»å
const successButton = document.querySelector('button.el-button--success');

// ä¼˜å…ˆçº§2: ä½¿ç”¨æ–‡æœ¬å†…å®¹åŒ¹é…
const buttons = document.querySelectorAll('button');
for (const button of buttons) {
  if (button.textContent?.includes('å‘é€ç»™å¥½å‹')) {
    button.click();
  }
}
```

**3. å¤šå±‚å¯¹è¯æ¡†ç²¾ç¡®å®šä½**

```typescript
// é€šè¿‡å¯¹è¯æ¡†æ ‡é¢˜åŒºåˆ†ä¸åŒå¯¹è¯æ¡†
const dialogs = document.querySelectorAll('.el-dialog__wrapper');
for (const dialog of dialogs) {
  const title = dialog.querySelector('.el-dialog__title');

  // å¾®å°å·é€‰æ‹©å¯¹è¯æ¡†
  if (title?.textContent?.includes('é€‰æ‹©å¾®å°å·')) {
    const footer = dialog.querySelector('.el-dialog__footer');
    // åœ¨footerä¸­æŸ¥æ‰¾æŒ‰é’®,é¿å…è¯¯ç‚¹ä¸»å¯¹è¯æ¡†çš„æŒ‰é’®
  }
}
```

**4. æŒ‰é’®æ–‡æœ¬ç²¾ç¡®åŒ¹é…**

```typescript
// ä¸»å¯¹è¯æ¡†çš„"ç¡®å®š"æŒ‰é’®: æ— ç©ºæ ¼
const mainDialogButton = 'ç¡®å®š';

// å¾®å°å·å¯¹è¯æ¡†çš„"ç¡® å®š"æŒ‰é’®: ä¸­é—´æœ‰ç©ºæ ¼
const miniAccountDialogButton = 'ç¡® å®š';

// åŒ¹é…æ—¶éœ€è¦è€ƒè™‘ç©ºæ ¼å·®å¼‚
const text = button.textContent?.trim();
if (text === 'ç¡® å®š' || (text?.includes('ç¡®') && text?.includes('å®š'))) {
  button.click();
}
```

#### å¸¸è§é—®é¢˜å’Œè§£å†³æ–¹æ¡ˆ

**é—®é¢˜1: æµ‹è¯•è„šæœ¬ä¸ç”Ÿäº§ä»£ç é€»è¾‘ä¸ä¸€è‡´**

- **ç°è±¡**: æœ¬åœ°æµ‹è¯•è„šæœ¬èƒ½å·¥ä½œ,ä½†ç”Ÿäº§ä»£ç å¤±è´¥
- **åŸå› **: æµ‹è¯•è„šæœ¬ä½¿ç”¨äº†ä¸åŒçš„é€‰æ‹©å™¨æˆ–ç‚¹å‡»æ–¹å¼
- **è§£å†³**: ç¡®ä¿æµ‹è¯•è„šæœ¬å’Œç”Ÿäº§ä»£ç çš„æ‰€æœ‰11ä¸ªæ­¥éª¤å®Œå…¨ä¸€è‡´

**é—®é¢˜2: PM2å·¥ä½œç›®å½•é”™è¯¯å¯¼è‡´ç¯å¢ƒå˜é‡è¯»å–å¤±è´¥**

- **ç°è±¡**: æœåŠ¡å¯åŠ¨æŠ¥é”™ `supabaseUrl is required`
- **åŸå› **: PM2ä»`/root`å¯åŠ¨,æ— æ³•è¯»å–`/www/wwwroot/pyq-backend/.env`
- **è§£å†³**: ä»æ­£ç¡®çš„å·¥ä½œç›®å½•å¯åŠ¨PM2
  ```bash
  cd /www/wwwroot/pyq-backend && pm2 start dist/main.js --name pyq-backend
  ```

**é—®é¢˜3: Vue Router keep-aliveå¯¼è‡´é¡µé¢ç©ºç™½**

- **ç°è±¡**: åˆ‡æ¢åˆ°å…¶ä»–é¡µé¢å,å†å›åˆ°Script2é¡µé¢æ˜¾ç¤ºç©ºç™½
- **åŸå› **: `onActivated`é’©å­ä¸­çš„å¼‚æ­¥æ“ä½œæ²¡æœ‰æ­£ç¡®å¤„ç†
- **è§£å†³**: æ·»åŠ `async/await`å’Œ`try-catch`é”™è¯¯å¤„ç†
  ```typescript
  onActivated(async () => {
    try {
      await loadMaterialStats();
      await loadMaterials();
      await loadFriends();
      if (!socket.value || !socket.value.connected) {
        initWebSocket();
      }
    } catch (error) {
      console.error('âŒ é¡µé¢æ¿€æ´»æ—¶åŠ è½½æ•°æ®å¤±è´¥:', error);
    }
  });
  ```

### 2. å¤šè´¦å·è½®è¯¢ç­–ç•¥

```typescript
// è½®è¯¢é¡ºåº: å¾®ä¿¡1â†’å¥½å‹1, å¾®ä¿¡2â†’å¥½å‹1, å¾®ä¿¡3â†’å¥½å‹1...
for (let i = 0; i < friends.length; i++) {
  const wechatIndex = i % wechatAccounts.length;
  const wechat = wechatAccounts[wechatIndex];
  await switchWechatAccount(wechat.id);
  await sendMessageToFriend(friends[i].name, message);
}
```

### 3. ç´ æåº“åŒæ­¥çš„Puppeteerå®ç°

ç´ æåº“åŒæ­¥åŠŸèƒ½è‡ªåŠ¨ä»å †é›ªçƒç³»ç»Ÿçˆ¬å–è§†é¢‘å·å’Œé“¾æ¥ç´ æ,ä¿å­˜åˆ°æ•°æ®åº“ä¾›å‰ç«¯é€‰æ‹©ã€‚

#### åŒæ­¥æµç¨‹

```typescript
async syncVideoMaterials(userId: string) {
  // 1. ç™»å½•å †é›ªçƒ
  await this.loginDuixueqiu(page);

  // 2. æ‰“å¼€ç´ æåº“
  await page.click('a[href="#/material/library"]');
  await page.waitForSelector('.material-library-container');

  // 3. é€‰æ‹©"è§†é¢‘å·ç´ æ"ç±»å‹
  await page.evaluate(() => {
    const buttons = document.querySelectorAll('button');
    for (const button of buttons) {
      if (button.textContent?.includes('è§†é¢‘å·ç´ æ')) {
        button.click();
        return;
      }
    }
  });

  // 4. ç­‰å¾…ç´ æåŠ è½½
  await page.waitForSelector('.material-item', { timeout: 10000 });

  // 5. æå–ç´ ææ•°æ®
  const materials = await page.evaluate(() => {
    const items = document.querySelectorAll('.material-item');
    return Array.from(items).map((item, index) => ({
      authorName: item.querySelector('.author-name')?.textContent?.trim(),
      contentDesc: item.querySelector('.content-desc')?.textContent?.trim(),
      thumbnailUrl: item.querySelector('img')?.src,
      materialIndex: index,
      pageNumber: 1
    }));
  });

  // 6. ä¿å­˜åˆ°æ•°æ®åº“(å»é‡)
  await this.saveMaterialsToDatabase(userId, materials);
}
```

#### å»é‡ç­–ç•¥

ä½¿ç”¨æ•°æ®åº“UNIQUEçº¦æŸè‡ªåŠ¨å»é‡:

```sql
UNIQUE(user_id, thumbnail_url)
```

```typescript
// æ’å…¥æ—¶ä½¿ç”¨ON CONFLICT DO NOTHING
await this.supabase
  .from('duixueqiu_video_materials')
  .insert(materials)
  .onConflict(['user_id', 'thumbnail_url'])
  .ignore();
```

### 4. æ™ºèƒ½é—´éš”è®¡ç®—

```typescript
calculateInterval(totalFriends, wechatCount, targetDays) {
  const totalSeconds = targetDays * 24 * 60 * 60;
  const baseInterval = totalSeconds / totalFriends;
  const actualInterval = baseInterval * wechatCount;
  return {
    baseInterval,      // åŸºç¡€é—´éš”(ç§’)
    actualInterval,    // å®é™…é—´éš”(ç§’)
    dailySend: Math.ceil(totalFriends / targetDays)  // æ¯å¤©å‘é€æ•°
  };
}
```

### 5. æ—¶é—´æ§åˆ¶æœºåˆ¶

```typescript
async waitForNextSendingTime() {
  const now = new Date();
  const hour = now.getHours();

  if (hour >= 22 || hour < 8) {
    // è®¡ç®—åˆ°æ¬¡æ—¥8:00çš„ç­‰å¾…æ—¶é—´
    const tomorrow8am = new Date(now);
    tomorrow8am.setDate(tomorrow8am.getDate() + (hour >= 22 ? 1 : 0));
    tomorrow8am.setHours(8, 0, 0, 0);

    const waitMs = tomorrow8am.getTime() - now.getTime();
    await new Promise(resolve => setTimeout(resolve, waitMs));
  }
}
```

### 6. æ¶ˆæ¯ä¸ªæ€§åŒ–

```typescript
const personalizedMessage = message.replace(/{æ˜µç§°}/g, friendName);
```

### 7. ä»»åŠ¡æ§åˆ¶

- **æš‚åœ**: è®¾ç½®`isPaused = true`,å½“å‰æ¶ˆæ¯å‘é€å®Œååœæ­¢
- **æ¢å¤**: è®¾ç½®`isPaused = false`,ä»ä¸Šæ¬¡ä½ç½®ç»§ç»­
- **åœæ­¢**: è®¾ç½®`isStopped = true`,ç«‹å³ç»ˆæ­¢ä»»åŠ¡

### 8. Vue Router Keep-Aliveå¤„ç†

Script2é¡µé¢ä½¿ç”¨Vue Routerçš„keep-aliveç¼“å­˜,éœ€è¦æ­£ç¡®å¤„ç†`onActivated`ç”Ÿå‘½å‘¨æœŸé’©å­ã€‚

#### é—®é¢˜åœºæ™¯

- ç”¨æˆ·ä»Script2åˆ‡æ¢åˆ°å…¶ä»–é¡µé¢,å†åˆ‡æ¢å›æ¥
- keep-aliveç¼“å­˜çš„ç»„ä»¶åªè§¦å‘`onActivated`,ä¸è§¦å‘`onMounted`
- å¦‚æœ`onActivated`ä¸­çš„å¼‚æ­¥æ“ä½œæ²¡æœ‰æ­£ç¡®å¤„ç†,é¡µé¢ä¼šæ˜¾ç¤ºç©ºç™½

#### è§£å†³æ–¹æ¡ˆ

```typescript
// âœ… æ­£ç¡®çš„onActivatedå®ç°
onActivated(async () => {
  console.log('ğŸ”„ Script2é¡µé¢å·²æ¿€æ´» (onActivated)');

  try {
    // é‡æ–°åˆå§‹åŒ–WebSocketè¿æ¥
    if (!socket.value || !socket.value.connected) {
      initWebSocket();
    }

    // é‡æ–°åŠ è½½æ‰€æœ‰æ•°æ®
    await loadMaterialStats();
    await loadMaterials();
    await loadLinkStats();
    await loadLinks();
    await loadFriends();

    addLog('ğŸ”„ é¡µé¢æ•°æ®å·²åˆ·æ–°');
  } catch (error) {
    console.error('âŒ é¡µé¢æ¿€æ´»æ—¶åŠ è½½æ•°æ®å¤±è´¥:', error);
    // å³ä½¿å‡ºé”™ä¹Ÿä¸ä¼šå¯¼è‡´é¡µé¢å´©æºƒ
  }
});
```

#### å…³é”®è¦ç‚¹

1. **å¿…é¡»ä½¿ç”¨async**: `onActivated(async () => { ... })`
2. **å¿…é¡»awaitå¼‚æ­¥æ“ä½œ**: `await loadMaterials()`
3. **å¿…é¡»æ·»åŠ é”™è¯¯å¤„ç†**: `try-catch`åŒ…è£¹æ‰€æœ‰å¼‚æ­¥æ“ä½œ
4. **WebSocketé‡è¿**: æ£€æŸ¥è¿æ¥çŠ¶æ€å¹¶é‡æ–°åˆå§‹åŒ–
5. **æ•°æ®åˆ·æ–°**: é‡æ–°åŠ è½½æ‰€æœ‰å¿…è¦çš„æ•°æ®

---

## âš ï¸ å·²çŸ¥é—®é¢˜

### 1. å †é›ªçƒè´¦å·ç¡¬ç¼–ç 

- å½“å‰è´¦å·å¯†ç å†™æ­»åœ¨ä»£ç ä¸­
- éœ€è¦æ”¹ä¸ºä»æ•°æ®åº“è¯»å–
- æ”¯æŒå¤šä¸ªå †é›ªçƒè´¦å·é…ç½®

### 2. å¥½å‹åˆ—è¡¨HTMLç»“æ„æœªéªŒè¯

- ä»£ç åŸºäºå‡è®¾çš„HTMLç»“æ„ç¼–å†™
- éœ€è¦å®é™…æµ‹è¯•éªŒè¯
- å¯èƒ½éœ€è¦è°ƒæ•´é€‰æ‹©å™¨

### 3. å‘é€å¤±è´¥æ— é‡è¯•

- å½“å‰å‘é€å¤±è´¥ç›´æ¥è·³è¿‡
- éœ€è¦æ·»åŠ é‡è¯•æœºåˆ¶
- è®°å½•å¤±è´¥åŸå› 

### 4. æ— å‘é€æˆåŠŸç‡ç»Ÿè®¡

- æ— æ³•çŸ¥é“å®é™…å‘é€æˆåŠŸå¤šå°‘æ¡
- éœ€è¦æ·»åŠ ç»Ÿè®¡åŠŸèƒ½
- ç”Ÿæˆå‘é€æŠ¥å‘Š

---

## ğŸ“– ä½¿ç”¨æŒ‡å—

### è§†é¢‘å·æ¶ˆæ¯å‘é€æµç¨‹

#### ç¬¬ä¸€æ­¥: åœ¨å †é›ªçƒä¸­æ”¶è—è§†é¢‘å·

1. åœ¨å¾®ä¿¡ä¸­æ‰¾åˆ°è¦å‘é€çš„è§†é¢‘å·
2. å‘é€ç»™å·¥ä½œå¾®ä¿¡
3. åœ¨å †é›ªçƒå®¢æˆ·ç«¯ä¸­å³é”®ç‚¹å‡»è¯¥æ¶ˆæ¯
4. é€‰æ‹©"æ”¶è—åˆ°ç´ æåº“"
5. é€‰æ‹©"å…¬å…±ç´ æåˆ†ç»„"
6. ä¿å­˜

#### ç¬¬äºŒæ­¥: åŒæ­¥ç´ æåº“

1. æ‰“å¼€è„šæœ¬2é¡µé¢
2. é€‰æ‹©"è§†é¢‘å·æ¶ˆæ¯"
3. ç‚¹å‡»"åŒæ­¥ç´ æåº“"æŒ‰é’®
4. ç­‰å¾…åŒæ­¥å®Œæˆ(çº¦10-30ç§’)

#### ç¬¬ä¸‰æ­¥: é€‰æ‹©ç´ æå¹¶å‘é€

1. åœ¨ç´ æåˆ—è¡¨ä¸­é€‰æ‹©è¦å‘é€çš„è§†é¢‘å·
2. (å¯é€‰)è¾“å…¥é™„åŠ æ–‡æ¡ˆ,æ”¯æŒ`{æ˜µç§°}`å˜é‡
3. é€‰æ‹©ç›®æ ‡å®Œæˆæ—¶é—´(å¦‚7å¤©)
4. ç‚¹å‡»"å¼€å§‹å‘é€"
5. æŸ¥çœ‹å®æ—¶è¿›åº¦å’Œæ—¥å¿—

### é“¾æ¥æ¶ˆæ¯å‘é€æµç¨‹

ä¸è§†é¢‘å·æ¶ˆæ¯ç±»ä¼¼,åªéœ€åœ¨ç¬¬äºŒæ­¥é€‰æ‹©"é“¾æ¥æ¶ˆæ¯"ç±»å‹å³å¯ã€‚

---

## ğŸ” æŠ€æœ¯è¦ç‚¹è¯¦è§£

### ğŸ¯ 2025-11-10 é‡å¤§çªç ´

#### 1. åˆ†é¡µæ£€æµ‹é€»è¾‘å®Œå–„

**é—®é¢˜**: æœ€åˆåªèƒ½è·å–ç¬¬1é¡µç´ æ(20ä¸ª),æ— æ³•è·å–æ‰€æœ‰é¡µ

**è§£å†³æ–¹æ¡ˆ**:
```typescript
// æ£€æµ‹ä¸‹ä¸€é¡µæŒ‰é’®
private async hasNextPage(page: puppeteer.Page): Promise<boolean> {
  const hasNext = await page.evaluate(() => {
    // æŸ¥æ‰¾æ‰€æœ‰åŒ…å«å³ç®­å¤´å›¾æ ‡çš„æŒ‰é’®
    const rightArrowButtons = Array.from(document.querySelectorAll('button')).filter(btn => {
      const icon = btn.querySelector('.el-icon-arrow-right');
      return icon !== null;
    });

    // æ£€æŸ¥æ˜¯å¦æœ‰æœªç¦ç”¨çš„ä¸‹ä¸€é¡µæŒ‰é’®
    for (const button of rightArrowButtons) {
      const isDisabled = button.classList.contains('is-disabled') || button.disabled;
      if (!isDisabled) {
        return true;
      }
    }
    return false;
  });
  return hasNext;
}
```

**å…³é”®ç‚¹**:
- âœ… ä½¿ç”¨`.el-icon-arrow-right`å›¾æ ‡å®šä½ä¸‹ä¸€é¡µæŒ‰é’®
- âœ… æ£€æŸ¥`is-disabled`ç±»å’Œ`disabled`å±æ€§
- âœ… æˆåŠŸå®ç°å¤šé¡µç´ æè·å–(ä»20ä¸ªâ†’39ä¸ª)

#### 2. æ•°æ®å»é‡ä¼˜åŒ–

**é—®é¢˜**: ä½¿ç”¨`(user_id, author_name, content_desc)`ç»„åˆå»é‡å¯¼è‡´ç´ æä¸¢å¤±

**åŸå› **: å¤šä¸ªè§†é¢‘å¯èƒ½æœ‰ç›¸åŒçš„ä½œè€…å’Œæè¿°

**è§£å†³æ–¹æ¡ˆ**:
```typescript
// ä½¿ç”¨thumbnail_urlä½œä¸ºå”¯ä¸€æ ‡è¯†
const uniqueMaterials = new Map<string, any>();
materialsToInsert.forEach(material => {
  const key = `${material.user_id}_${material.thumbnail_url}`;
  uniqueMaterials.set(key, material);
});
```

**æ•°æ®åº“çº¦æŸè°ƒæ•´**:
```sql
-- åˆ é™¤æ—§çº¦æŸ
ALTER TABLE duixueqiu_video_materials
DROP CONSTRAINT duixueqiu_video_materials_user_id_author_name_content_desc_key;

-- ä½¿ç”¨æ–°çº¦æŸ
UNIQUE(user_id, thumbnail_url)
```

**æ•ˆæœ**: æˆåŠŸåŒæ­¥æ‰€æœ‰39ä¸ªç´ æ,æ— é‡å¤æ— é—æ¼

#### 3. å‰ç«¯UIä¼˜åŒ–

**ç´ æé€‰æ‹©å¼¹çª—åŒ–**:
```vue
<!-- ä½¿ç”¨Vben Adminçš„Modalç»„ä»¶ -->
<MaterialModal
  class="w-[90vw] max-w-[1400px] h-[85vh]"
  title="é€‰æ‹©è§†é¢‘å·ç´ æ"
  :footer="false"
>
  <!-- ç´ æç½‘æ ¼: ä¸€è¡Œ6ä¸ª -->
  <div class="grid grid-cols-6 gap-3 max-h-[calc(85vh-120px)] overflow-y-auto">
    <!-- ç´ æå¡ç‰‡ -->
  </div>
</MaterialModal>
```

**ä¼˜åŒ–ç‚¹**:
- âœ… å¼¹çª—å®½åº¦: 1400px (åŸ1200px)
- âœ… å¼¹çª—é«˜åº¦: 85vh (åŸ600pxå›ºå®šé«˜åº¦)
- âœ… ç´ æç½‘æ ¼: ä¸€è¡Œ6ä¸ª (åŸ4ä¸ª)
- âœ… æ¶ˆæ¯ç±»å‹é€‰æ‹©åŒºåŸŸé«˜åº¦å‹ç¼©

---

## ğŸ”§ Puppeteeré€‰æ‹©å™¨å‚è€ƒ

**é‡è¦**: ä»¥ä¸‹é€‰æ‹©å™¨éœ€è¦æ ¹æ®å †é›ªçƒå®é™…HTMLç»“æ„è°ƒæ•´

### ç´ æåº“ç›¸å…³é€‰æ‹©å™¨

```typescript
// ç´ ææŒ‰é’®
await page.click('[title="ç´ æ"]');

// è§†é¢‘å·ç´ æèœå•
await page.click('div:has-text("è§†é¢‘å·ç´ æ")');

// é“¾æ¥ç´ æèœå•
await page.click('div:has-text("é“¾æ¥ç´ æ")');

// å…¬å…±ç´ æåˆ†ç»„
await page.click('div:has-text("å…¬å…±ç´ æåˆ†ç»„")');

// ç´ æé¡¹
const materialItems = await page.$$('.item-resource');

// åˆ†é¡µæŒ‰é’®
const nextButton = await page.$('button .el-icon-arrow-right');
```

### å‘é€ç›¸å…³é€‰æ‹©å™¨

```typescript
// å¥½å‹é€‰æ‹©
await page.click(`[title="${friendName}"]`);

// èŠå¤©æ¡†è¾“å…¥
await page.type('#editArea', message);

// å‘é€æŒ‰é’®
await page.click('.send-btn');
```

---

## ğŸ› ï¸ è°ƒè¯•å»ºè®®

1. **ä½¿ç”¨headless: false** - æŸ¥çœ‹æµè§ˆå™¨å®é™…æ“ä½œè¿‡ç¨‹
2. **æ·»åŠ æˆªå›¾** - åœ¨å…³é”®æ­¥éª¤æ·»åŠ `await page.screenshot()`è®°å½•çŠ¶æ€
3. **ä½¿ç”¨waitForSelector** - ç­‰å¾…å…ƒç´ åŠ è½½å®Œæˆ,é¿å…å…ƒç´ æœªæ‰¾åˆ°é”™è¯¯
4. **é¿å…ç¡¬ç¼–ç å»¶è¿Ÿ** - ä½¿ç”¨æ™ºèƒ½ç­‰å¾…(`waitForSelector`, `waitForNavigation`)æ›¿ä»£`setTimeout`
5. **ä½¿ç”¨page.evaluate** - åœ¨æµè§ˆå™¨ä¸Šä¸‹æ–‡ä¸­æ‰§è¡Œå¤æ‚é€»è¾‘,æé«˜æ€§èƒ½

---

## âš ï¸ æ³¨æ„äº‹é¡¹

### 1. ç´ æåº“åŒæ­¥

- âœ… é¦–æ¬¡ä½¿ç”¨éœ€è¦å…ˆåŒæ­¥ç´ æåº“
- âœ… å»ºè®®å®šæœŸåŒæ­¥(å¦‚æ¯å¤©ä¸€æ¬¡)
- âœ… åŒæ­¥æ—¶é—´å–å†³äºç´ ææ•°é‡(çº¦10-30ç§’)
- âš ï¸ åŒæ­¥è¿‡ç¨‹ä¸­ä¸è¦å…³é—­æµè§ˆå™¨

### 2. å‘é€é™åˆ¶

- âœ… éµå¾ªå¾®ä¿¡å‘é€é¢‘ç‡é™åˆ¶
- âœ… å»ºè®®è®¾ç½®åˆç†çš„ç›®æ ‡å¤©æ•°(7-14å¤©)
- âœ… é¿å…çŸ­æ—¶é—´å¤§é‡å‘é€(å¯èƒ½è¢«å¾®ä¿¡é™åˆ¶)
- âš ï¸ å‘é€æ—¶é—´æ§åˆ¶åœ¨8:00-22:00

### 3. é€‰æ‹©å™¨ç»´æŠ¤

- âœ… å †é›ªçƒç•Œé¢æ›´æ–°å¯èƒ½å¯¼è‡´é€‰æ‹©å™¨å¤±æ•ˆ
- âœ… éœ€è¦å®šæœŸæ£€æŸ¥å’Œæ›´æ–°é€‰æ‹©å™¨
- âœ… å»ºè®®ä½¿ç”¨æ›´ç¨³å®šçš„é€‰æ‹©å™¨(å¦‚data-*å±æ€§)
- âš ï¸ é€‰æ‹©å™¨å¤±æ•ˆæ—¶æŸ¥çœ‹æµè§ˆå™¨æ§åˆ¶å°é”™è¯¯ä¿¡æ¯

---

## ğŸ“‹ å¾…ä¼˜åŒ–é¡¹

- [ ] å †é›ªçƒè´¦å·é…ç½®åŒ–
- [ ] å¥½å‹åˆ—è¡¨HTMLç»“æ„éªŒè¯
- [ ] å‘é€å¤±è´¥é‡è¯•æœºåˆ¶
- [ ] å‘é€æˆåŠŸç‡ç»Ÿè®¡
- [ ] æ”¯æŒåˆ†ç»„å‘é€
- [ ] æ”¯æŒé»‘åå•è¿‡æ»¤
- [ ] æ·»åŠ å‘é€æŠ¥å‘Šå¯¼å‡º

---

## ğŸ”— ç›¸å…³æ–‡æ¡£

- [è„šæœ¬1: è¾“å…¥é“¾æ¥è‡ªåŠ¨å‘å¸ƒ](./è„šæœ¬1-è¾“å…¥é“¾æ¥è‡ªåŠ¨å‘å¸ƒ.md)
- [è„šæœ¬3: å®šæ—¶ç›‘æ§è‡ªåŠ¨å‘å¸ƒ](./è„šæœ¬3-å®šæ—¶ç›‘æ§è‡ªåŠ¨å‘å¸ƒ.md)
- [è„šæœ¬4: è·Ÿåœˆè‡ªåŠ¨åŒ–](./è„šæœ¬4-è·Ÿåœˆè‡ªåŠ¨åŒ–.md)
- [éƒ¨ç½²æŒ‡å—](./éƒ¨ç½²æŒ‡å—.md)
- [å¸¸è§é—®é¢˜](./å¸¸è§é—®é¢˜.md)

---

## ğŸ› é‡è¦Bugä¿®å¤è®°å½•

### å¥½å‹åŒæ­¥åŠŸèƒ½ - å¾®ä¿¡å·åˆ‡æ¢å¤±è´¥é—®é¢˜ (V5.5.2)

#### é—®é¢˜æè¿°

**ç°è±¡:**
- ç‚¹å‡»"1å·æœº"è¿›è¡Œå¥½å‹åŒæ­¥
- é¡µé¢æ˜¾ç¤º"1å·æœº"è¢«é€‰ä¸­(CSSçš„`.selected`ç±»æ­£ç¡®åº”ç”¨)
- ä½†å®é™…åŠ è½½çš„æ˜¯"10å·æœº"çš„å¥½å‹æ•°æ®(9948ä¸ªå¥½å‹è€Œä¸æ˜¯6396ä¸ª)
- å¯¼è‡´åŒæ­¥é”™è¯¯çš„å¾®ä¿¡å·å¥½å‹æ•°æ®

**å½±å“èŒƒå›´:**
- æ‰€æœ‰å¾®ä¿¡å·çš„å¥½å‹åŒæ­¥åŠŸèƒ½
- æ•°æ®ä¸ä¸€è‡´,ç”¨æˆ·ä½“éªŒæ··ä¹±

#### æ ¹æœ¬åŸå› 

å †é›ªçƒå¹³å°ä½¿ç”¨Vue.jsæ¡†æ¶,å¾®ä¿¡å·åˆ—è¡¨çš„ç‚¹å‡»äº‹ä»¶é€šè¿‡Vueçš„`@click`äº‹ä»¶ç›‘å¬å™¨å¤„ç†ã€‚

**Puppeteerçš„ä¸‰ç§ç‚¹å‡»æ–¹å¼å¯¹æ¯”:**

| ç‚¹å‡»æ–¹å¼ | ä»£ç  | æ˜¯å¦è§¦å‘Vueäº‹ä»¶ | ç»“æœ |
|---------|------|----------------|------|
| PuppeteeråŸç”Ÿç‚¹å‡» | `elementHandle.click()` | âŒ å¦ | åªè§¦å‘DOMäº‹ä»¶,ä¸è§¦å‘Vue |
| JavaScriptç‚¹å‡» | `element.click()` | âŒ å¦ | åªæ”¹å˜CSSæ ·å¼,ä¸æ›´æ–°Vueæ•°æ® |
| æ¨¡æ‹Ÿé¼ æ ‡äº‹ä»¶ | `dispatchEvent(MouseEvent)` | âœ… æ˜¯ | æ­£ç¡®è§¦å‘Vueäº‹ä»¶ç›‘å¬å™¨ |

**é—®é¢˜æ ¸å¿ƒ:** JavaScriptçš„`click()`æ–¹æ³•åªè§¦å‘å…ƒç´ çš„`onclick`å±æ€§,æ— æ³•è§¦å‘Vueçš„`@click`äº‹ä»¶ç›‘å¬å™¨,å¯¼è‡´CSSæ ·å¼æ”¹å˜ä½†Vueæ•°æ®çŠ¶æ€æœªæ›´æ–°ã€‚

#### è§£å†³æ–¹æ¡ˆ

**1. ä½¿ç”¨dispatchEventæ¨¡æ‹ŸçœŸå®é¼ æ ‡ç‚¹å‡»**

```typescript
// âŒ é”™è¯¯çš„æ–¹å¼ - ä¸è§¦å‘Vueäº‹ä»¶
const clickResult = await page.evaluate((name) => {
  const items = document.querySelectorAll('.wechat-account-list > .item');
  for (const item of items) {
    const nameDiv = item.querySelector('.name');
    if (nameDiv && nameDiv.textContent?.trim() === name) {
      (item as HTMLElement).click(); // åªæ”¹å˜CSS,ä¸è§¦å‘Vue
      return { success: true };
    }
  }
  return { success: false };
}, accountName);

// âœ… æ­£ç¡®çš„æ–¹å¼ - è§¦å‘Vueäº‹ä»¶
const clickResult = await page.evaluate((name) => {
  const items = document.querySelectorAll('.wechat-account-list > .item');
  for (const item of items) {
    const nameDiv = item.querySelector('.name');
    if (nameDiv && nameDiv.textContent?.trim() === name) {
      // æ¨¡æ‹ŸçœŸå®çš„é¼ æ ‡ç‚¹å‡»äº‹ä»¶
      const clickEvent = new MouseEvent('click', {
        view: window,
        bubbles: true,    // äº‹ä»¶å†’æ³¡
        cancelable: true  // å¯å–æ¶ˆ
      });
      item.dispatchEvent(clickEvent); // è§¦å‘Vueäº‹ä»¶ç›‘å¬å™¨
      return { success: true, title: item.getAttribute('title') || '' };
    }
  }
  return { success: false, title: '' };
}, accountName);
```

**2. å¢åŠ åŒé‡éªŒè¯é€»è¾‘**

ä¸ä»…æ£€æŸ¥CSSæ ·å¼,è¿˜è¦éªŒè¯Vueçš„æ•°æ®çŠ¶æ€æ˜¯å¦çœŸæ­£æ”¹å˜:

```typescript
// åŒæ—¶è·å–å¥½å‹æ•°å’Œå½“å‰é€‰ä¸­çš„å¾®ä¿¡å·
const result = await page.evaluate((targetName) => {
  // è·å–æœªåˆ†ç»„å¥½å‹æ•°
  let friendCount = 0;
  const allSpans = document.querySelectorAll('span');
  for (const span of allSpans) {
    const text = span.textContent?.trim() || '';
    const match = text.match(/^æœªåˆ†ç»„[ï¼ˆ(](\d+)ä¸ª[ï¼‰)]$/);
    if (match) {
      friendCount = parseInt(match[1], 10);
      break;
    }
  }

  // è·å–å½“å‰é€‰ä¸­çš„å¾®ä¿¡å·
  let selectedAccount = '';
  const items = document.querySelectorAll('.wechat-account-list > .item');
  for (const item of items) {
    if (item.classList.contains('selected')) {
      const nameDiv = item.querySelector('.name');
      selectedAccount = nameDiv?.textContent?.trim() || '';
      break;
    }
  }

  return { friendCount, selectedAccount };
}, accountName);

// éªŒè¯:å¥½å‹æ•°>0 ä¸” é€‰ä¸­çš„å¾®ä¿¡å·æ­£ç¡®
if (result.friendCount > 0 && result.selectedAccount === accountName) {
  this.logger.log(`âœ… éªŒè¯é€šè¿‡! å¥½å‹æ•°: ${result.friendCount}, é€‰ä¸­: ${result.selectedAccount}`);
  clickSuccess = true;
} else if (result.friendCount > 0 && result.selectedAccount !== accountName) {
  this.logger.warn(`âš ï¸ å¾®ä¿¡å·ä¸åŒ¹é…! å½“å‰: ${result.selectedAccount}, æœŸæœ›: ${accountName}`);
  // è§¦å‘é‡è¯•
}
```

**3. è‡ªåŠ¨é‡è¯•æœºåˆ¶**

```typescript
let retryCount = 0;
const maxRetries = 5;
let clickSuccess = false;

while (!clickSuccess && retryCount < maxRetries) {
  if (retryCount > 0) {
    this.logger.warn(`ğŸ”„ ç¬¬ ${retryCount + 1} æ¬¡å°è¯•ç‚¹å‡»å¾®ä¿¡å·: ${accountName}`);
  }

  // æ‰§è¡Œç‚¹å‡»å’ŒéªŒè¯...

  if (!clickSuccess) {
    retryCount++;
    await new Promise(resolve => setTimeout(resolve, 2000)); // ç­‰å¾…2ç§’åé‡è¯•
  }
}
```

**4. æ»šåŠ¨åŠ è½½å‚æ•°ä¼˜åŒ–**

```typescript
const maxScrollAttempts = 5000; // ä»2000å¢åŠ åˆ°5000æ¬¡
const stableCount = 100;        // ä»10å¢åŠ åˆ°100(è¿ç»­50ç§’ä¸å˜æ‰åœæ­¢)
```

**è®¡ç®—ä¾æ®:**
- æ¯æ¬¡æ»šåŠ¨åŠ è½½çº¦2-5ä¸ªå¥½å‹
- 6396ä¸ªå¥½å‹éœ€è¦çº¦3200æ¬¡æ»šåŠ¨
- è®¾ç½®5000æ¬¡ç¡®ä¿æœ‰è¶³å¤Ÿä½™é‡

#### ä¿®å¤æ•ˆæœ

**ä¿®å¤å‰:**
```
âœ… å·²ç‚¹å‡»å¾®ä¿¡å·: 1å·æœº
âœ… å¥½å‹æ•°æ®å·²æ›´æ–°! ä» 0 å˜ä¸º 9948  âŒ é”™è¯¯!
ğŸ” å½“å‰é€‰ä¸­çš„å¾®ä¿¡å·: æ²ªæ¸¯çºªè€æ¿(10å·æœº)  âŒ é”™è¯¯!
```

**ä¿®å¤å:**
```
ğŸ”„ ç¬¬ 3 æ¬¡å°è¯•ç‚¹å‡»å¾®ä¿¡å·: 1å·æœº
âœ… å·²ä½¿ç”¨JavaScriptç‚¹å‡»å¾®ä¿¡å·: 1å·æœº
âœ… å¥½å‹æ•°æ®å·²æ›´æ–°! å¥½å‹æ•°: 6396, é€‰ä¸­å¾®ä¿¡å·: 1å·æœº  âœ… æ­£ç¡®!
ğŸ“Š å·²æ”¶é›† 275 ä¸ªå¥½å‹... (æ»šåŠ¨æ¬¡æ•°: 50)
ğŸ“Š å·²æ”¶é›† 544 ä¸ªå¥½å‹... (æ»šåŠ¨æ¬¡æ•°: 100)
ğŸ“Š å·²æ”¶é›† 2648 ä¸ªå¥½å‹... (æ»šåŠ¨æ¬¡æ•°: 500)
```

#### æŠ€æœ¯è¦ç‚¹æ€»ç»“

1. **Vueäº‹ä»¶è§¦å‘**: ä½¿ç”¨`dispatchEvent(new MouseEvent('click'))`è€Œä¸æ˜¯`element.click()`
2. **åŒé‡éªŒè¯**: ä¸ä»…æ£€æŸ¥CSSæ ·å¼,è¿˜è¦éªŒè¯Vueçš„æ•°æ®çŠ¶æ€
3. **è‡ªåŠ¨é‡è¯•**: é‡åˆ°å¤±è´¥è‡ªåŠ¨é‡è¯•,æé«˜æˆåŠŸç‡
4. **è€å¿ƒç­‰å¾…**: Vueæ¸²æŸ“éœ€è¦æ—¶é—´,ç»™è¶³å¤Ÿçš„è¶…æ—¶æ—¶é—´(90ç§’)
5. **æ»šåŠ¨ç­–ç•¥**: è™šæ‹Ÿæ»šåŠ¨éœ€è¦æŒç»­æ»šåŠ¨,è®¾ç½®è¶³å¤Ÿçš„æ¬¡æ•°å’Œç¨³å®šæ€§é˜ˆå€¼

#### é€‚ç”¨åœºæ™¯

è¿™ä¸ªè§£å†³æ–¹æ¡ˆé€‚ç”¨äºæ‰€æœ‰ä½¿ç”¨Vue.js/Reactç­‰æ¡†æ¶çš„SPAåº”ç”¨çš„Puppeteerè‡ªåŠ¨åŒ–åœºæ™¯,ç‰¹åˆ«æ˜¯éœ€è¦è§¦å‘æ¡†æ¶äº‹ä»¶ç›‘å¬å™¨çš„æƒ…å†µã€‚

---

[â† è¿”å›README](./README.md)

