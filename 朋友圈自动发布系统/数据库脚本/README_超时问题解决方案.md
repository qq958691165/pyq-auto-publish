# å¥½å‹åˆ—è¡¨æŸ¥è¯¢è¶…æ—¶é—®é¢˜è§£å†³æ–¹æ¡ˆ

## ğŸ” é—®é¢˜æè¿°

**é”™è¯¯ä¿¡æ¯**: `canceling statement due to statement timeout`

**åŸå› **: 
- Supabaseé»˜è®¤çš„`statement_timeout`è¾ƒçŸ­(é€šå¸¸15-30ç§’)
- å¥½å‹æ•°é‡è¾ƒå¤šæ—¶(5000+),å•æ¬¡æŸ¥è¯¢å¯èƒ½è¶…æ—¶
- æ•°æ®åº“ç´¢å¼•ä¸è¶³æˆ–æœªä½¿ç”¨

---

## âœ… è§£å†³æ–¹æ¡ˆ(æŒ‰ä¼˜å…ˆçº§æ’åº)

### æ–¹æ¡ˆ1: åœ¨Supabaseæ§åˆ¶å°å¢åŠ è¶…æ—¶æ—¶é—´ â­â­â­â­â­

**æ­¥éª¤**:

1. **ç™»å½•Supabaseæ§åˆ¶å°**
   - è®¿é—®: https://supabase.com/dashboard
   - é€‰æ‹©æ‚¨çš„é¡¹ç›®

2. **æ‰“å¼€SQL Editor**
   - å·¦ä¾§èœå• â†’ SQL Editor
   - ç‚¹å‡» "New query"

3. **æ‰§è¡Œä»¥ä¸‹SQL**:

```sql
-- æŸ¥çœ‹å½“å‰è¶…æ—¶è®¾ç½®
SHOW statement_timeout;

-- å¢åŠ è¶…æ—¶æ—¶é—´åˆ°60ç§’(æ¨è)
ALTER DATABASE postgres SET statement_timeout = '60s';

-- æˆ–è€…è®¾ç½®ä¸º120ç§’(å¦‚æœå¥½å‹æ•°é‡ç‰¹åˆ«å¤š)
-- ALTER DATABASE postgres SET statement_timeout = '120s';
```

4. **é‡æ–°è¿æ¥æ•°æ®åº“**
   - å…³é—­æ‰€æœ‰æ•°æ®åº“è¿æ¥
   - é‡å¯åç«¯æœåŠ¡

**ä¼˜ç‚¹**: 
- âœ… ä¸€åŠ³æ°¸é€¸,æ‰€æœ‰æŸ¥è¯¢éƒ½ç”Ÿæ•ˆ
- âœ… ä¸éœ€è¦ä¿®æ”¹ä»£ç 

**ç¼ºç‚¹**:
- âŒ éœ€è¦æ•°æ®åº“è¶…çº§ç”¨æˆ·æƒé™
- âŒ Supabaseå…è´¹ç‰ˆå¯èƒ½ä¸æ”¯æŒ

---

### æ–¹æ¡ˆ2: ä¼˜åŒ–æ•°æ®åº“ç´¢å¼• â­â­â­â­â­

**æ­¥éª¤**:

1. **åœ¨Supabase SQL Editorä¸­æ‰§è¡Œ**:

```sql
-- åˆ›å»ºè¦†ç›–ç´¢å¼•(åŒ…å«æ‰€æœ‰æŸ¥è¯¢å­—æ®µ)
CREATE INDEX IF NOT EXISTS idx_duixueqiu_friends_covering 
ON duixueqiu_friends(user_id, friend_name) 
INCLUDE (id, friend_remark, avatar_url, wechat_account_name, is_selected);

-- åˆ†æè¡¨,æ›´æ–°ç»Ÿè®¡ä¿¡æ¯
ANALYZE duixueqiu_friends;

-- æ¸…ç†æ­»å…ƒç»„
VACUUM ANALYZE duixueqiu_friends;
```

2. **éªŒè¯ç´¢å¼•æ˜¯å¦ç”Ÿæ•ˆ**:

```sql
-- æŸ¥çœ‹æŸ¥è¯¢è®¡åˆ’(æ›¿æ¢YOUR_USER_ID)
EXPLAIN ANALYZE
SELECT id, friend_name, friend_remark, avatar_url, wechat_account_name, is_selected
FROM duixueqiu_friends
WHERE user_id = 'YOUR_USER_ID'
ORDER BY friend_name
LIMIT 1000;
```

**ä¼˜ç‚¹**:
- âœ… å¤§å¹…æå‡æŸ¥è¯¢é€Ÿåº¦(å¯èƒ½ä»30ç§’é™åˆ°1ç§’)
- âœ… ä¸éœ€è¦ä¿®æ”¹ä»£ç 
- âœ… å…è´¹ç‰ˆä¹Ÿå¯ä»¥ä½¿ç”¨

**ç¼ºç‚¹**:
- âŒ éœ€è¦ä¸€å®šçš„SQLçŸ¥è¯†

---

### æ–¹æ¡ˆ3: åç«¯ä»£ç ä¼˜åŒ–(å·²å®ç°) â­â­â­â­

**å·²ä¼˜åŒ–å†…å®¹**:

1. **å‡å°‘æ‰¹æ¬¡å¤§å°**: ä»2000æ”¹ä¸º1000
2. **å‡å°‘æŸ¥è¯¢å­—æ®µ**: ç§»é™¤ä¸å¿…è¦çš„`user_id`å’Œ`wechat_account_index`
3. **è¶…æ—¶å®¹é”™**: é‡åˆ°è¶…æ—¶æ—¶è¿”å›å·²è·å–çš„æ•°æ®,è€Œä¸æ˜¯æŠ¥é”™
4. **æ‰¹æ¬¡å»¶è¿Ÿ**: æ¯5000æ¡æ•°æ®æš‚åœ100ms,å‡è½»æ•°æ®åº“å‹åŠ›

**ä»£ç ä½ç½®**: `duixueqiu-friends.service.ts` ç¬¬1245-1312è¡Œ

**ä¼˜ç‚¹**:
- âœ… æå‡æŸ¥è¯¢ç¨³å®šæ€§
- âœ… å³ä½¿è¶…æ—¶ä¹Ÿèƒ½è¿”å›éƒ¨åˆ†æ•°æ®

**ç¼ºç‚¹**:
- âŒ å¦‚æœæ•°æ®åº“æœ¬èº«å¾ˆæ…¢,æ•ˆæœæœ‰é™

---

### æ–¹æ¡ˆ4: ä½¿ç”¨è¿æ¥æ± é…ç½®(é«˜çº§) â­â­â­

**åœ¨åç«¯ç¯å¢ƒå˜é‡ä¸­é…ç½®**:

```env
# .envæ–‡ä»¶
DATABASE_URL=postgresql://user:pass@host:5432/db?statement_timeout=60000
```

**ä¼˜ç‚¹**:
- âœ… é’ˆå¯¹ç‰¹å®šè¿æ¥è®¾ç½®è¶…æ—¶
- âœ… ä¸å½±å“å…¶ä»–æ•°æ®åº“æ“ä½œ

**ç¼ºç‚¹**:
- âŒ éœ€è¦ä¿®æ”¹ç¯å¢ƒå˜é‡å¹¶é‡å¯æœåŠ¡

---

## ğŸ§ª æµ‹è¯•éªŒè¯

### 1. æŸ¥çœ‹å½“å‰å¥½å‹æ•°é‡

```sql
SELECT 
  user_id,
  COUNT(*) as friend_count
FROM duixueqiu_friends
GROUP BY user_id
ORDER BY friend_count DESC;
```

### 2. æµ‹è¯•æŸ¥è¯¢æ€§èƒ½

```sql
-- æ›¿æ¢YOUR_USER_IDä¸ºå®é™…ç”¨æˆ·ID
EXPLAIN ANALYZE
SELECT id, friend_name, friend_remark, avatar_url, wechat_account_name, is_selected
FROM duixueqiu_friends
WHERE user_id = 'YOUR_USER_ID'
ORDER BY friend_name;
```

**å…³é”®æŒ‡æ ‡**:
- `Execution Time`: åº”è¯¥ < 5ç§’
- `Index Scan`: åº”è¯¥ä½¿ç”¨ç´¢å¼•,è€Œä¸æ˜¯`Seq Scan`(å…¨è¡¨æ‰«æ)

---

## ğŸ“Š æ¨èç»„åˆæ–¹æ¡ˆ

**æœ€ä½³å®è·µ**:

1. âœ… **å…ˆæ‰§è¡Œæ–¹æ¡ˆ2**(ä¼˜åŒ–ç´¢å¼•) - 5åˆ†é’Ÿ
2. âœ… **å¦‚æœè¿˜è¶…æ—¶,æ‰§è¡Œæ–¹æ¡ˆ1**(å¢åŠ è¶…æ—¶æ—¶é—´) - 2åˆ†é’Ÿ
3. âœ… **æ–¹æ¡ˆ3å·²è‡ªåŠ¨ç”Ÿæ•ˆ**(ä»£ç ä¼˜åŒ–) - æ— éœ€æ“ä½œ

**é¢„æœŸæ•ˆæœ**:
- æŸ¥è¯¢æ—¶é—´ä»30ç§’é™åˆ° < 5ç§’
- å³ä½¿å¶å°”è¶…æ—¶,ä¹Ÿèƒ½è¿”å›éƒ¨åˆ†æ•°æ®
- ç”¨æˆ·ä½“éªŒå¤§å¹…æå‡

---

## ğŸ”§ æ•…éšœæ’æŸ¥

### å¦‚æœè¿˜æ˜¯è¶…æ—¶:

1. **æ£€æŸ¥æ•°æ®é‡**:
```sql
SELECT COUNT(*) FROM duixueqiu_friends WHERE user_id = 'YOUR_USER_ID';
```

2. **æ£€æŸ¥ç´¢å¼•æ˜¯å¦å­˜åœ¨**:
```sql
SELECT indexname, indexdef 
FROM pg_indexes 
WHERE tablename = 'duixueqiu_friends';
```

3. **æ£€æŸ¥æ•°æ®åº“è´Ÿè½½**:
   - Supabaseæ§åˆ¶å° â†’ Database â†’ Performance
   - æŸ¥çœ‹CPUå’Œå†…å­˜ä½¿ç”¨ç‡

4. **è”ç³»Supabaseæ”¯æŒ**:
   - å¦‚æœæ˜¯å…è´¹ç‰ˆ,è€ƒè™‘å‡çº§åˆ°Proç‰ˆ
   - Proç‰ˆæœ‰æ›´é«˜çš„èµ„æºé…é¢å’Œè¶…æ—¶é™åˆ¶

---

## ğŸ“ æ€»ç»“

- **ç«‹å³æ‰§è¡Œ**: æ–¹æ¡ˆ2(ä¼˜åŒ–ç´¢å¼•)
- **å¦‚æœè¿˜è¶…æ—¶**: æ–¹æ¡ˆ1(å¢åŠ è¶…æ—¶æ—¶é—´)
- **å·²è‡ªåŠ¨ç”Ÿæ•ˆ**: æ–¹æ¡ˆ3(ä»£ç ä¼˜åŒ–)

åˆ€ä»”è€æ¿,å»ºè®®æ‚¨å…ˆæ‰§è¡Œæ–¹æ¡ˆ2çš„SQLè„šæœ¬,åº”è¯¥å°±èƒ½è§£å†³é—®é¢˜! ğŸ˜Š

